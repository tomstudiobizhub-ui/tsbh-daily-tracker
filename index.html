<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#6c5ce7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>TOMSTUDIO DAILY PERFORMANCE TRACKER</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.png" type="image/png">
  <link rel="apple-touch-icon" href="logo-192.png">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1200px;
      margin: 10px auto;
      padding: 15px;
    }

    /* Login Screen */
    .screen {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      overflow: hidden;
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #loginScreen {
      text-align: center;
      padding: 40px 20px;
    }

    #loginScreen img {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      border-radius: 50%;
      border: 4px solid #6c5ce7;
    }

    #loginScreen h1 {
      color: #6c5ce7;
      font-size: 2.2rem;
      margin-bottom: 8px;
    }

    #loginScreen h3 {
      color: #2d3436;
      margin-bottom: 15px;
      font-weight: 600;
    }

    #loginScreen p {
      color: #636e72;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    #loginScreen input {
      width: 100%;
      max-width: 300px;
      padding: 14px;
      margin: 12px auto;
      border: 2px solid #ddd;
      border-radius: 50px;
      font-size: 16px;
      text-align: center;
      display: block;
    }

    #loginScreen button {
      background: linear-gradient(45deg, #6c5ce7, #a55eea);
      color: white;
      border: none;
      padding: 14px 35px;
      border-radius: 50px;
      font-size: 17px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
      margin-top: 10px;
    }

    /* Navigation */
    nav {
      background: white;
      border-radius: 15px;
      padding: 5px;
      margin: 15px 0;
      display: flex;
      overflow-x: auto;
      gap: 2px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    nav a {
      display: block;
      padding: 12px 20px;
      color: #636e72;
      text-decoration: none;
      font-weight: 600;
      border-radius: 10px;
      white-space: nowrap;
      transition: all 0.3s;
    }

    nav a.active {
      background: #6c5ce7;
      color: white;
      box-shadow: 0 3px 10px rgba(108, 92, 231, 0.4);
    }

    /* Main App */
    #mainApp {
      display: none;
      padding: 20px;
    }

    #mainApp img.mal {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #6c5ce7;
      margin: 0 auto 15px;
      display: block;
    }

    #mainApp h1 {
      text-align: center;
      color: #6c5ce7;
      margin-bottom: 8px;
      font-size: 1.8rem;
    }

    #mainApp h1 span {
      color: #2d3436;
      font-weight: 700;
    }

    #mainApp p {
      text-align: center;
      color: #636e72;
      margin-bottom: 25px;
      font-size: 1rem;
    }

    /* Sign In Section */
    .sign-in-info {
      background: linear-gradient(45deg, #00b894, #00cec9);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .sign-in-info h3 {
      margin-bottom: 12px;
      font-size: 1.4rem;
    }

    .sign-in-info p {
      margin: 8px 0;
      font-size: 1rem;
    }

    .time-location-btn {
      background: #2d3436;
      color: white;
      border: none;
      padding: 13px 25px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form */
    .form {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .form h3 {
      color: #6c5ce7;
      margin-bottom: 18px;
      text-align: center;
      font-size: 1.4rem;
    }

    .form input, .form textarea, .form select {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
    }

    .form input:focus, .form textarea:focus, .form select:focus {
      border-color: #6c5ce7;
      outline: none;
    }

    .form textarea {
      min-height: 90px;
      resize: vertical;
    }

    .form button {
      background: linear-gradient(45deg, #6c5ce7, #a55eea);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 10px;
      font-size: 17px;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
    }

    /* Image Upload */
    .image-upload {
      border: 2px dashed #ddd;
      padding: 20px;
      text-align: center;
      margin: 15px 0;
      border-radius: 10px;
    }

    .image-preview {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
      margin: 10px 0;
    }

    .image-item {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-item .delete-img {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(225, 112, 85, 0.9);
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
    }

    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .gallery-item {
      position: relative;
      height: 150px;
      border-radius: 10px;
      overflow: hidden;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-item .delete-img {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(225, 112, 85, 0.9);
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
    }

    /* Export */
    .export {
      display: flex;
      gap: 12px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    .export button {
      flex: 1;
      min-width: 140px;
      background: linear-gradient(45deg, #fd79a8, #e84393);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(236, 90, 159, 0.4);
    }

    /* Buttons */
    .clear-btn, .logout-btn {
      background: #2d3436;
      color: white;
      border: none;
      padding: 11px 22px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      margin: 8px 4px;
    }

    /* Summary Cards */
    .summary-box {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    .summary-card {
      flex: 1;
      min-width: 200px;
      background: #f1f2f6;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .summary-card h4 {
      font-size: 0.9rem;
      color: #636e72;
      margin-bottom: 5px;
    }

    .summary-card p {
      font-size: 1.4rem;
      font-weight: bold;
      color: #2d3436;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 30px;
      color: white;
      font-size: 0.9rem;
      margin-top: 30px;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 12px;
      }
      
      #loginScreen {
        padding: 30px 15px;
      }
      
      #loginScreen h1 {
        font-size: 1.8rem;
      }
      
      #mainApp {
        padding: 15px;
      }
      
      .export {
        flex-direction: column;
      }
      
      .export button {
        width: 100%;
      }
      
      .summary-box {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
      <img src="logo-192.png" alt="TOMSTUDIO Logo">
      <h1>TOMSTUDIO DAILY PERFORMANCE TRACKER</h1>
      <h3>COMPLETE FIELD OPERATIONS</h3>
      <p>Please log in with your Staff ID</p>
      <input type="text" id="staffId" placeholder="Enter Staff ID" maxlength="10" />
      <button onclick="login()">🔓 Log In</button>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="screen">
      <div style="text-align: center;">
        <img src="logo-192.png" alt="TOMSTUDIO Logo" class="mal">
      </div>
      
      <h1>🎯 Welcome, <span id="staffDisplay"></span>!</h1>
      <p>Track your daily performance and activities.</p>

      <!-- Sign In Section -->
      <div class="sign-in-info">
        <h3>📍 Daily Sign In & GPS Location</h3>
        <p id="signInTime">Not signed in</p>
        <p id="locationInfo">Location: Not tracked</p>
        <button class="time-location-btn" onclick="recordSignIn()">
          🕒 Record Sign-In & Get GPS Coordinates
        </button>
      </div>

      <!-- Navigation Tabs -->
      <nav>
        <a href="#" class="tab-link active" data-tab="clients">Clients/Visitors</a>
        <a href="#" class="tab-link" data-tab="staff">Onsite Staff</a>
        <a href="#" class="tab-link" data-tab="learning">Student Learning</a>
        <a href="#" class="tab-link" data-tab="sales">Daily Sales</a>
        <a href="#" class="tab-link" data-tab="registration">New Students</a>
        <a href="#" class="tab-link" data-tab="finance">Income & Expenses</a>
        <a href="#" class="tab-link" data-tab="gallery">Class Gallery</a>
        <a href="#" class="tab-link" data-tab="reports">Reports</a>
      </nav>

      <!-- Clients/Visitors Tab -->
      <section id="clients" class="tab-content active">
        <div class="form">
          <h3>📝 Client/Visitor Details</h3>
          <input type="text" id="clientName" placeholder="Client Name" />
          <input type="text" id="clientPhone" placeholder="Phone Number" />
          <input type="email" id="clientEmail" placeholder="Email (optional)" />
          <textarea id="clientComment" placeholder="Purpose of visit, feedback, or comments..."></textarea>
          <button onclick="addClient()">✅ Add Client</button>
          <button onclick="clearClients()" class="clear-btn" style="width:auto; margin-top:10px;">🗑️ Clear All</button>
        </div>

        <div id="clientList"></div>
      </section>

      <!-- Onsite Staff Tab -->
      <section id="staff" class="tab-content">
        <div class="form">
          <h3>👷 Onsite Staff Daily Tasks</h3>
          <input type="text" id="staffName" placeholder="Staff Name" />
          <select id="staffRole">
            <option value="">Select Role</option>
            <option value="Teacher">Teacher</option>
            <option value="Cleaner">Cleaner</option>
            <option value="Security">Security</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Admin">Admin</option>
          </select>
          <textarea id="staffActivity" placeholder="Daily activities and tasks completed..."></textarea>
          <div class="image-upload">
            <p>📸 Upload Activity Photos</p>
            <input type="file" id="staffPhotos" accept="image/*" multiple>
          </div>
          <button onclick="addStaffActivity()">✅ Record Activity</button>
          <button onclick="clearStaff()" class="clear-btn" style="width:auto; margin-top:10px;">🗑️ Clear All</button>
        </div>

        <div id="staffList"></div>
      </section>

      <!-- Student Learning Tab -->
      <section id="learning" class="tab-content">
        <div class="form">
          <h3>📚 Student Learning Log</h3>
          <input type="text" id="className" placeholder="Class Name (e.g., Primary 3)" />
          <textarea id="topicsCovered" placeholder="Topics covered today..."></textarea>
          <textarea id="studentProgress" placeholder="Student progress and challenges..."></textarea>
          <div class="image-upload">
            <p>📸 Upload Class Activity Photos</p>
            <input type="file" id="learningPhotos" accept="image/*" multiple>
          </div>
          <button onclick="addLearningLog()">✅ Record Learning</button>
          <button onclick="clearLearning()" class="clear-btn" style="width:auto; margin-top:10px;">🗑️ Clear All</button>
        </div>

        <div id="learningList"></div>
      </section>

      <!-- Daily Sales Tab -->
      <section id="sales" class="tab-content">
        <div class="form">
          <h3>💰 Daily Sales</h3>
          <input type="text" id="saleItem" placeholder="Item Sold" />
          <input type="number" id="saleAmount" placeholder="Amount (₦)" />
          <textarea id="saleNotes" placeholder="Additional notes..."></textarea>
          <button onclick="addSale()">✅ Record Sale</button>
          <button onclick="clearSales()" class="clear-btn" style="width:auto; margin-top:10px;">🗑️ Clear All</button>
        </div>

        <div id="salesList"></div>
        <div style="background:white; padding:15px; border-radius:10px; margin:15px 0;">
          <h4>💰 Today's Total Sales: <span id="dailySalesTotal">₦0</span></h4>
        </div>
      </section>

      <!-- New Student Registration -->
      <section id="registration" class="tab-content">
        <div class="form">
          <h3>🎓 New Student Registration</h3>
          <input type="text" id="studentName" placeholder="Student Name" />
          <input type="text" id="studentAge" placeholder="Age" />
          <input type="text" id="studentClass" placeholder="Class" />
          <input type="text" id="parentName" placeholder="Parent/Guardian Name" />
          <input type="text" id="parentPhone" placeholder="Parent Phone" />
          <textarea id="studentNotes" placeholder="Additional information..."></textarea>
          <button onclick="registerStudent()">✅ Register Student</button>
          <button onclick="clearRegistrations()" class="clear-btn" style="width:auto; margin-top:10px;">🗑️ Clear All</button>
        </div>

        <div id="registrationList"></div>
      </section>

      <!-- Income & Expenses -->
      <section id="finance" class="tab-content">
        <div class="form">
          <h3>📊 Income & Expenses</h3>
          <select id="financeType">
            <option value="">Select Type</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <input type="text" id="financeItem" placeholder="Item/Description" />
          <input type="number" id="financeAmount" placeholder="Amount (₦)" />
          <textarea id="financeNotes" placeholder="Additional notes..."></textarea>
          <button onclick="addFinance()">✅ Record Transaction</button>
          <button onclick="clearFinance()" class="clear-btn" style="width:auto; margin-top:10px;">🗑️ Clear All</button>
        </div>

        <div id="financeList"></div>
        <div style="background:white; padding:15px; border-radius:10px; margin:15px 0;">
          <h4>📊 Today's Summary:</h4>
          <p>Income: <span id="totalIncome">₦0</span> | Expenses: <span id="totalExpenses">₦0</span> | Net: <span id="netBalance">₦0</span></p>
        </div>
      </section>

      <!-- Class Gallery Tab -->
      <section id="gallery" class="tab-content">
        <h2>🖼️ Class Gallery</h2>
        <button onclick="clearGallery()" class="clear-btn" style="margin:10px 0;">🗑️ Clear All Images</button>
        <div class="gallery" id="galleryImages"></div>
      </section>

      <!-- Reports Tab -->
      <section id="reports" class="tab-content">
        <h2>📄 Comprehensive Reports</h2>
        <div class="export">
          <button onclick="generatePDF()">📄 Generate PDF Report</button>
          <button onclick="exportToCSV()">📥 Export to CSV</button>
        </div>
        
        <div class="summary-box" style="margin: 20px 0;">
          <div class="summary-card">
            <h4>Clients</h4>
            <p id="clientCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Staff</h4>
            <p id="staffCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Learning</h4>
            <p id="learningCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Sales</h4>
            <p id="salesCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Students</h4>
            <p id="studentCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Transactions</h4>
            <p id="financeCount">0</p>
          </div>
        </div>
      </section>

      <div style="text-align: center; margin-top: 20px;">
        <button class="logout-btn" onclick="logout()">↩️ Logout</button>
      </div>
    </div>

    <footer>
      &copy; <strong>App Design and Developed by Tomstudio Tech Academy</strong> | Contact: <a href="tel:+2348030827417" style="color: #fdcb6e;">+2348030827417</a>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Global Variables
    let currentStaffId = null;
    let clients = [];
    let staffActivities = [];
    let learningLogs = [];
    let sales = [];
    let students = [];
    let finances = [];
    let galleryImages = [];
    let signInData = {};

    // DOM Elements
    const loginScreen = document.getElementById("loginScreen");
    const mainApp = document.getElementById("mainApp");
    const staffIdInput = document.getElementById("staffId");
    const staffDisplay = document.getElementById("staffDisplay");
    const signInTimeElement = document.getElementById("signInTime");
    const locationInfoElement = document.getElementById("locationInfo");

    // Tab Navigation
    document.querySelectorAll('.tab-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = link.getAttribute('data-tab');
        
        // Remove active class
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-link').forEach(tab => {
          tab.classList.remove('active');
        });

        // Add active class
        document.getElementById(tabId).classList.add('active');
        link.classList.add('active');

        // Refresh content
        if (tabId === 'clients') renderClients();
        if (tabId === 'staff') renderStaff();
        if (tabId === 'learning') renderLearning();
        if (tabId === 'sales') renderSales();
        if (tabId === 'registration') renderRegistrations();
        if (tabId === 'finance') renderFinance();
        if (tabId === 'gallery') renderGallery();
        if (tabId === 'reports') updateReportStats();
      });
    });

    // Login
    function login() {
      const id = staffIdInput.value.trim();
      if (!id) {
        alert("Please enter your Staff ID");
        return;
      }
      currentStaffId = id;
      staffDisplay.textContent = id;
      loginScreen.style.display = "none";
      mainApp.style.display = "block";
      loadAllData();
    }

    // Logout
    function logout() {
      if (confirm("Log out?")) {
        currentStaffId = null;
        loginScreen.style.display = "block";
        mainApp.style.display = "none";
        staffIdInput.value = "";
      }
    }

    // Get Keys
    function getTodayKey(prefix) {
      return `${prefix}_${currentStaffId}_${new Date().toISOString().split("T")[0]}`;
    }

    // Record Sign-In Time and Location (GPS only)
    function recordSignIn() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const dateStr = now.toLocaleDateString();
      
      signInData = {
        time: timeStr,
        date: dateStr,
        timestamp: now.toISOString()
      };

      if (navigator.geolocation) {
        locationInfoElement.textContent = "📍 Getting GPS coordinates...";
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            signInData.location = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            
            locationInfoElement.innerHTML = `
              📍 <strong>Latitude:</strong> ${position.coords.latitude.toFixed(6)}<br>
              📍 <strong>Longitude:</strong> ${position.coords.longitude.toFixed(6)}<br>
              📏 <strong>Accuracy:</strong> ${position.coords.accuracy}m
            `;
            
            saveSignInData(signInData);
          },
          (error) => {
            console.log("Location error:", error);
            locationInfoElement.textContent = "📍 Location: Permission denied or unavailable";
            saveSignInData(signInData);
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
        );
      } else {
        locationInfoElement.textContent = "📍 Location: Not supported by browser";
        saveSignInData(signInData);
      }

      signInTimeElement.textContent = `Signed in at ${timeStr} on ${dateStr}`;
    }

    // Save sign-in data
    function saveSignInData(data) {
      try {
        localStorage.setItem(`signin_${currentStaffId}`, JSON.stringify(data));
      } catch (e) {
        console.error("Storage error:", e);
      }
    }

    // Display sign-in data
    function displaySignInData() {
      const saved = localStorage.getItem(`signin_${currentStaffId}`);
      if (saved) {
        const data = JSON.parse(saved);
        signInData = data;
        signInTimeElement.textContent = `Signed in at ${data.time} on ${data.date}`;
        if (data.location) {
          locationInfoElement.innerHTML = `
            📍 <strong>Latitude:</strong> ${data.location.lat.toFixed(6)}<br>
            📍 <strong>Longitude:</strong> ${data.location.lng.toFixed(6)}<br>
            📏 <strong>Accuracy:</strong> ${data.location.accuracy}m
          `;
        }
      }
    }

    // Add Client
    function addClient() {
      const name = document.getElementById("clientName").value.trim();
      const phone = document.getElementById("clientPhone").value.trim();
      const email = document.getElementById("clientEmail").value.trim();
      const comment = document.getElementById("clientComment").value.trim();

      if (!name) {
        alert("Please enter client name");
        return;
      }

      const now = new Date();
      const client = {
        id: Date.now(),
        name,
        phone,
        email,
        comment,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };

      clients.push(client);
      saveData('clients', clients);
      renderClients();
      clearForm(['clientName', 'clientPhone', 'clientEmail', 'clientComment']);
    }

    // Render Clients
    function renderClients() {
      const list = document.getElementById("clientList");
      list.innerHTML = "";
      
      if (clients.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No clients recorded today.</p>";
        return;
      }

      clients.forEach(client => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #00b894;";
        div.innerHTML = `
          <strong>${client.name}</strong>
          ${client.phone ? `<div>📞 ${client.phone}</div>` : ""}
          ${client.email ? `<div>✉️ ${client.email}</div>` : ""}
          ${client.comment ? `<div style="color:#636e72; margin:8px 0;">💬 ${client.comment}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            📅 ${client.date} | ⏰ ${client.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    // Add Staff Activity
    function addStaffActivity() {
      const name = document.getElementById("staffName").value.trim();
      const role = document.getElementById("staffRole").value;
      const activity = document.getElementById("staffActivity").value.trim();
      const photos = document.getElementById("staffPhotos").files;

      if (!name || !role || !activity) {
        alert("Please fill all fields");
        return;
      }

      const now = new Date();
      const staff = {
        id: Date.now(),
        name,
        role,
        activity,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString(),
        photos: []
      };

      // Process images
      if (photos.length > 0) {
        for (let i = 0; i < photos.length; i++) {
          const reader = new FileReader();
          reader.onload = function(e) {
            staff.photos.push(e.target.result);
            if (i === photos.length - 1) {
              staffActivities.push(staff);
              saveData('staff', staffActivities);
              renderStaff();
              clearForm(['staffName', 'staffRole', 'staffActivity', 'staffPhotos']);
            }
          };
          reader.readAsDataURL(photos[i]);
        }
      } else {
        staffActivities.push(staff);
        saveData('staff', staffActivities);
        renderStaff();
        clearForm(['staffName', 'staffRole', 'staffActivity', 'staffPhotos']);
      }
    }

    // Render Staff
    function renderStaff() {
      const list = document.getElementById("staffList");
      list.innerHTML = "";
      
      if (staffActivities.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No staff activities recorded today.</p>";
        return;
      }

      staffActivities.forEach(staff => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #0984e3;";
        div.innerHTML = `
          <strong>${staff.name} (${staff.role})</strong>
          <div style="color:#636e72; margin:8px 0;">${staff.activity}</div>
          ${staff.photos.length > 0 ? `<div style="margin:10px 0;"><strong>Photos:</strong></div>` : ""}
          <div style="display:flex; gap:5px; overflow-x:auto; padding:5px 0;">
            ${staff.photos.map(photo => `
              <div style="width:80px; height:80px; border-radius:8px; overflow:hidden; flex-shrink:0;">
                <img src="${photo}" style="width:100%; height:100%; object-fit:cover;">
              </div>
            `).join('')}
          </div>
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            📅 ${staff.date} | ⏰ ${staff.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    // Add Learning Log
    function addLearningLog() {
      const className = document.getElementById("className").value.trim();
      const topics = document.getElementById("topicsCovered").value.trim();
      const progress = document.getElementById("studentProgress").value.trim();
      const photos = document.getElementById("learningPhotos").files;

      if (!className || !topics) {
        alert("Please fill required fields");
        return;
      }

      const now = new Date();
      const log = {
        id: Date.now(),
        className,
        topics,
        progress,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString(),
        photos: []
      };

      // Process images
      if (photos.length > 0) {
        for (let i = 0; i < photos.length; i++) {
          const reader = new FileReader();
          reader.onload = function(e) {
            log.photos.push(e.target.result);
            galleryImages.push({
              id: Date.now() + i,
              src: e.target.result,
              caption: `${className} - ${now.toLocaleDateString()}`,
              timestamp: now.toISOString()
            });
            if (i === photos.length - 1) {
              learningLogs.push(log);
              saveData('learning', learningLogs);
              saveData('gallery', galleryImages);
              renderLearning();
              renderGallery();
              clearForm(['className', 'topicsCovered', 'studentProgress', 'learningPhotos']);
            }
          };
          reader.readAsDataURL(photos[i]);
        }
      } else {
        learningLogs.push(log);
        saveData('learning', learningLogs);
        renderLearning();
        clearForm(['className', 'topicsCovered', 'studentProgress', 'learningPhotos']);
      }
    }

    // Render Learning
    function renderLearning() {
      const list = document.getElementById("learningList");
      list.innerHTML = "";
      
      if (learningLogs.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No learning logs recorded today.</p>";
        return;
      }

      learningLogs.forEach(log => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #fdcb6e;";
        div.innerHTML = `
          <strong>${log.className}</strong>
          <div style="color:#636e72; margin:8px 0;"><strong>Topics:</strong> ${log.topics}</div>
          ${log.progress ? `<div style="color:#636e72; margin:8px 0;"><strong>Progress:</strong> ${log.progress}</div>` : ""}
          ${log.photos.length > 0 ? `<div style="margin:10px 0;"><strong>Class Photos:</strong></div>` : ""}
          <div style="display:flex; gap:5px; overflow-x:auto; padding:5px 0;">
            ${log.photos.map(photo => `
              <div style="width:80px; height:80px; border-radius:8px; overflow:hidden; flex-shrink:0;">
                <img src="${photo}" style="width:100%; height:100%; object-fit:cover;">
              </div>
            `).join('')}
          </div>
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            📅 ${log.date} | ⏰ ${log.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    // Add Sale
    function addSale() {
      const item = document.getElementById("saleItem").value.trim();
      const amount = parseFloat(document.getElementById("saleAmount").value);
      const notes = document.getElementById("saleNotes").value.trim();

      if (!item || isNaN(amount)) {
        alert("Please fill all fields correctly");
        return;
      }

      const now = new Date();
      const sale = {
        id: Date.now(),
        item,
        amount,
        notes,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };

      sales.push(sale);
      saveData('sales', sales);
      renderSales();
      clearForm(['saleItem', 'saleAmount', 'saleNotes']);
    }

    // Render Sales
    function renderSales() {
      const list = document.getElementById("salesList");
      list.innerHTML = "";
      
      if (sales.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No sales recorded today.</p>";
        return;
      }

      let total = 0;
      sales.forEach(sale => {
        total += sale.amount;
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #fdcb6e;";
        div.innerHTML = `
          <strong>${sale.item}</strong>
          <div style="color:#636e72; margin:8px 0;">Amount: ₦${sale.amount.toLocaleString()}</div>
          ${sale.notes ? `<div style="color:#636e72; margin:8px 0;">📝 ${sale.notes}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            📅 ${sale.date} | ⏰ ${sale.time}
          </div>
        `;
        list.appendChild(div);
      });

      document.getElementById("dailySalesTotal").textContent = `₦${total.toLocaleString()}`;
    }

    // Register Student
    function registerStudent() {
      const name = document.getElementById("studentName").value.trim();
      const age = document.getElementById("studentAge").value.trim();
      const className = document.getElementById("studentClass").value.trim();
      const parent = document.getElementById("parentName").value.trim();
      const phone = document.getElementById("parentPhone").value.trim();
      const notes = document.getElementById("studentNotes").value.trim();

      if (!name || !age || !className || !parent || !phone) {
        alert("Please fill all required fields");
        return;
      }

      const now = new Date();
      const student = {
        id: Date.now(),
        name,
        age,
        className,
        parent,
        phone,
        notes,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };

      students.push(student);
      saveData('students', students);
      renderRegistrations();
      clearForm(['studentName', 'studentAge', 'studentClass', 'parentName', 'parentPhone', 'studentNotes']);
    }

    // Render Registrations
    function renderRegistrations() {
      const list = document.getElementById("registrationList");
      list.innerHTML = "";
      
      if (students.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No new students registered today.</p>";
        return;
      }

      students.forEach(student => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #a55eea;";
        div.innerHTML = `
          <strong>${student.name}</strong>
          <div style="color:#636e72; margin:8px 0;">Age: ${student.age} | Class: ${student.className}</div>
          <div style="color:#636e72; margin:8px 0;">Parent: ${student.parent} | Phone: ${student.phone}</div>
          ${student.notes ? `<div style="color:#636e72; margin:8px 0;">📝 ${student.notes}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            📅 ${student.date} | ⏰ ${student.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    // Add Finance
    function addFinance() {
      const type = document.getElementById("financeType").value;
      const item = document.getElementById("financeItem").value.trim();
      const amount = parseFloat(document.getElementById("financeAmount").value);
      const notes = document.getElementById("financeNotes").value.trim();

      if (!type || !item || isNaN(amount)) {
        alert("Please fill all fields correctly");
        return;
      }

      const now = new Date();
      const transaction = {
        id: Date.now(),
        type,
        item,
        amount,
        notes,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };

      finances.push(transaction);
      saveData('finances', finances);
      renderFinance();
      clearForm(['financeType', 'financeItem', 'financeAmount', 'financeNotes']);
    }

    // Render Finance
    function renderFinance() {
      const list = document.getElementById("financeList");
      list.innerHTML = "";
      
      if (finances.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No financial transactions recorded today.</p>";
        return;
      }

      let income = 0;
      let expenses = 0;
      
      finances.forEach(trans => {
        if (trans.type === 'income') income += trans.amount;
        else if (trans.type === 'expense') expenses += trans.amount;
        
        const div = document.createElement("div");
        div.style.cssText = `background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid ${trans.type === 'income' ? '#00b894' : '#e17055'};`;
        div.innerHTML = `
          <strong>${trans.type === 'income' ? '💰' : '💸'} ${trans.item}</strong>
          <div style="color:#636e72; margin:8px 0;">Amount: ₦${trans.amount.toLocaleString()}</div>
          ${trans.notes ? `<div style="color:#636e72; margin:8px 0;">📝 ${trans.notes}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            📅 ${trans.date} | ⏰ ${trans.time}
          </div>
        `;
        list.appendChild(div);
      });

      const net = income - expenses;
      document.getElementById("totalIncome").textContent = `₦${income.toLocaleString()}`;
      document.getElementById("totalExpenses").textContent = `₦${expenses.toLocaleString()}`;
      document.getElementById("netBalance").textContent = `₦${net.toLocaleString()}`;
    }

    // Render Gallery
    function renderGallery() {
      const container = document.getElementById("galleryImages");
      container.innerHTML = "";
      
      if (galleryImages.length === 0) {
        container.innerHTML = "<p style='text-align:center; padding:20px;'>No images in gallery.</p>";
        return;
      }

      galleryImages.forEach(img => {
        const item = document.createElement("div");
        item.className = "gallery-item";
        item.innerHTML = `
          <img src="${img.src}" alt="Class photo">
          <button class="delete-img" onclick="deleteGalleryImage(${img.id})">×</button>
        `;
        container.appendChild(item);
      });
    }

    // Delete Gallery Image
    function deleteGalleryImage(id) {
      if (confirm("Delete this image?")) {
        galleryImages = galleryImages.filter(img => img.id !== id);
        saveData('gallery', galleryImages);
        renderGallery();
      }
    }

    // Update Report Stats
    function updateReportStats() {
      document.getElementById("clientCount").textContent = clients.length;
      document.getElementById("staffCount").textContent = staffActivities.length;
      document.getElementById("learningCount").textContent = learningLogs.length;
      document.getElementById("salesCount").textContent = sales.length;
      document.getElementById("studentCount").textContent = students.length;
      document.getElementById("financeCount").textContent = finances.length;
    }

    // Save Data
    function saveData(key, data) {
      try {
        localStorage.setItem(getTodayKey(key), JSON.stringify(data));
      } catch (e) {
        console.error("Storage error:", e);
        alert("Could not save data. Please check your browser storage.");
      }
    }

    // Load Data
    function loadData(key) {
      try {
        const saved = localStorage.getItem(getTodayKey(key));
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error("Load error:", e);
        return [];
      }
    }

    // Clear Form Fields
    function clearForm(fieldIds) {
      fieldIds.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.type === 'file') {
          element.value = '';
        } else if (element) {
          element.value = '';
        }
      });
    }

    // Clear Functions
    function clearClients() {
      if (confirm("Clear all client records?")) {
        clients = [];
        saveData('clients', clients);
        renderClients();
      }
    }

    function clearStaff() {
      if (confirm("Clear all staff records?")) {
        staffActivities = [];
        saveData('staff', staffActivities);
        renderStaff();
      }
    }

    function clearLearning() {
      if (confirm("Clear all learning records?")) {
        learningLogs = [];
        saveData('learning', learningLogs);
        renderLearning();
      }
    }

    function clearSales() {
      if (confirm("Clear all sales records?")) {
        sales = [];
        saveData('sales', sales);
        renderSales();
      }
    }

    function clearRegistrations() {
      if (confirm("Clear all student registrations?")) {
        students = [];
        saveData('students', students);
        renderRegistrations();
      }
    }

    function clearFinance() {
      if (confirm("Clear all financial records?")) {
        finances = [];
        saveData('finances', finances);
        renderFinance();
      }
    }

    function clearGallery() {
      if (confirm("Clear all gallery images?")) {
        galleryImages = [];
        saveData('gallery', galleryImages);
        renderGallery();
      }
    }

    // Export to CSV
    function exportToCSV() {
      try {
        let csv = "Category,Details,Amount,Date,Time\n";
        
        // Clients
        clients.forEach(c => {
          csv += `Client,"${c.name}; ${c.phone || ''}; ${c.email || ''}",,"${c.date}","${c.time}"\n`;
        });
        
        // Staff
        staffActivities.forEach(s => {
          csv += `Staff,"${s.name} (${s.role}); ${s.activity}",,"${s.date}","${s.time}"\n`;
        });
        
        // Learning
        learningLogs.forEach(l => {
          csv += `Learning,"${l.className}; Topics: ${l.topics}; Progress: ${l.progress}",,"${l.date}","${l.time}"\n`;
        });
        
        // Sales
        sales.forEach(s => {
          csv += `Sale,"${s.item}; ${s.notes}",₦${s.amount},"${s.date}","${s.time}"\n`;
        });
        
        // Students
        students.forEach(st => {
          csv += `Student,"${st.name}; Age: ${st.age}; Class: ${st.className}; Parent: ${st.parent}; Phone: ${st.phone}; ${st.notes}",,"${st.date}","${st.time}"\n`;
        });
        
        // Finances
        finances.forEach(f => {
          csv += `${f.type.toUpperCase()},"${f.item}; ${f.notes}",₦${f.amount},"${f.date}","${f.time}"\n`;
        });

        downloadFile(csv, `performance_report_${currentStaffId}_${new Date().toISOString().split("T")[0]}.csv`, "text/csv");
      } catch (e) {
        console.error("CSV export error:", e);
        alert("Could not generate CSV. Please try again.");
      }
    }

    // Generate Single-Page PDF Report with GPS Coordinates
    function generatePDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const today = new Date().toLocaleDateString();
        const primaryColor = [108, 92, 231];
        const textColor = [66, 66, 66];
        const leftMargin = 20;
        const contentWidth = 170;

        // Header
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text("TOMSTUDIO DAILY PERFORMANCE TRACKER", 105, 20, null, null, "center");
        doc.setFontSize(14);
        doc.text("Comprehensive Daily Report", 105, 30, null, null, "center");

        // Reset color
        doc.setTextColor(...textColor);

        // Function to add text with proper formatting
        function addText(text, x, y, isBold = false, fontSize = 10) {
          doc.setFontSize(fontSize);
          doc.setFont("helvetica", isBold ? "bold" : "normal");
          doc.text(text, x, y);
          return y + 6;
        }

        // Function to add wrapped text
        function addWrappedText(text, x, y, maxWidth, fontSize = 10) {
          doc.setFontSize(fontSize);
          const lines = doc.splitTextToSize(text, maxWidth);
          lines.forEach(line => {
            if (y > 280) {
              doc.addPage();
              y = 20;
            }
            doc.text(line, x, y);
            y += 5;
          });
          return y;
        }

        // Staff Information
        let yPos = 50;
        yPos = addText("STAFF INFORMATION", leftMargin, yPos, true, 12);
        
        yPos = addText(`Staff ID: ${currentStaffId}`, leftMargin, yPos);
        yPos = addText(`Date: ${today}`, leftMargin, yPos);
        
        if (signInData.location) {
          yPos = addText("GPS LOCATION", leftMargin, yPos, true, 12);
          yPos = addText(`Latitude: ${signInData.location.lat.toFixed(6)}`, leftMargin, yPos, false, 14);
          yPos = addText(`Longitude: ${signInData.location.lng.toFixed(6)}`, leftMargin, yPos, false, 14);
          yPos = addText(`Accuracy: ${signInData.location.accuracy}m`, leftMargin, yPos);
        }
        
        yPos += 6;

        // Clients Section
        if (clients.length > 0) {
          yPos = addText("CLIENTS/VISITORS", leftMargin, yPos, true, 12);
          
          clients.forEach(client => {
            if (yPos > 260) {
              doc.addPage();
              yPos = 20;
            }
            
            yPos = addText(`${client.name}`, leftMargin, yPos, true);
            
            if (client.phone) {
              yPos = addText(`📞 Phone: ${client.phone}`, leftMargin, yPos);
            }
            if (client.email) {
              yPos = addText(`✉️ Email: ${client.email}`, leftMargin, yPos);
            }
            if (client.comment) {
              yPos = addWrappedText(`💬 ${client.comment}`, leftMargin, yPos, contentWidth);
            }
            
            yPos = addText(`${client.date} ${client.time}`, leftMargin, yPos);
            yPos += 2;
          });
          
          yPos += 4;
        }

        // Staff Activities
        if (staffActivities.length > 0) {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          
          yPos = addText("ONSITE STAFF ACTIVITIES", leftMargin, yPos, true, 12);
          
          staffActivities.forEach(staff => {
            if (yPos > 260) {
              doc.addPage();
              yPos = 20;
            }
            
            yPos = addText(`${staff.name} (${staff.role})`, leftMargin, yPos, true);
            yPos = addWrappedText(staff.activity, leftMargin, yPos, contentWidth);
            yPos = addText(`${staff.date} ${staff.time}`, leftMargin, yPos);
            yPos += 2;
          });
          
          yPos += 4;
        }

        // Student Learning
        if (learningLogs.length > 0) {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          
          yPos = addText("STUDENT LEARNING LOGS", leftMargin, yPos, true, 12);
          
          learningLogs.forEach(log => {
            if (yPos > 260) {
              doc.addPage();
              yPos = 20;
            }
            
            yPos = addText(`${log.className}`, leftMargin, yPos, true);
            yPos = addWrappedText(`Topics: ${log.topics}`, leftMargin, yPos, contentWidth);
            if (log.progress) {
              yPos = addWrappedText(`Progress: ${log.progress}`, leftMargin, yPos, contentWidth);
            }
            yPos = addText(`${log.date} ${log.time}`, leftMargin, yPos);
            yPos += 2;
          });
          
          yPos += 4;
        }

        // Daily Sales
        if (sales.length > 0) {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          
          yPos = addText("DAILY SALES", leftMargin, yPos, true, 12);
          
          let totalSales = sales.reduce((sum, s) => sum + s.amount, 0);
          yPos = addText(`Today's Total Sales: ₦${totalSales.toLocaleString()}`, leftMargin, yPos, true);
          
          sales.forEach(sale => {
            if (yPos > 260) {
              doc.addPage();
              yPos = 20;
            }
            
            yPos = addText(`${sale.item}`, leftMargin, yPos);
            yPos = addText(`Amount: ₦${sale.amount.toLocaleString()}`, leftMargin, yPos);
            if (sale.notes) {
              yPos = addWrappedText(`📝 ${sale.notes}`, leftMargin, yPos, contentWidth);
            }
            yPos = addText(`${sale.date} ${sale.time}`, leftMargin, yPos);
            yPos += 2;
          });
          
          yPos += 4;
        }

        // New Student Registrations
        if (students.length > 0) {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          
          yPos = addText("NEW STUDENT REGISTRATIONS", leftMargin, yPos, true, 12);
          
          students.forEach(student => {
            if (yPos > 260) {
              doc.addPage();
              yPos = 20;
            }
            
            yPos = addText(`${student.name}`, leftMargin, yPos, true);
            yPos = addText(`Age: ${student.age} | Class: ${student.className}`, leftMargin, yPos);
            yPos = addText(`Parent: ${student.parent} | Phone: ${student.phone}`, leftMargin, yPos);
            if (student.notes) {
              yPos = addWrappedText(`📝 ${student.notes}`, leftMargin, yPos, contentWidth);
            }
            yPos = addText(`${student.date} ${student.time}`, leftMargin, yPos);
            yPos += 2;
          });
          
          yPos += 4;
        }

        // Income & Expenses
        if (finances.length > 0) {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          
          yPos = addText("INCOME & EXPENSES", leftMargin, yPos, true, 12);
          
          let income = 0;
          let expenses = 0;
          finances.forEach(f => {
            if (f.type === 'income') income += f.amount;
            else if (f.type === 'expense') expenses += f.amount;
          });
          
          yPos = addText(`Total Income: ₦${income.toLocaleString()}`, leftMargin, yPos);
          yPos = addText(`Total Expenses: ₦${expenses.toLocaleString()}`, leftMargin, yPos);
          yPos = addText(`Net Balance: ₦${(income - expenses).toLocaleString()}`, leftMargin, yPos, true);
          
          finances.forEach(trans => {
            if (yPos > 260) {
              doc.addPage();
              yPos = 20;
            }
            
            yPos = addText(`${trans.type === 'income' ? '💰' : '💸'} ${trans.item}`, leftMargin, yPos, true);
            yPos = addText(`Amount: ₦${trans.amount.toLocaleString()}`, leftMargin, yPos);
            if (trans.notes) {
              yPos = addWrappedText(`📝 ${trans.notes}`, leftMargin, yPos, contentWidth);
            }
            yPos = addText(`${trans.date} ${trans.time}`, leftMargin, yPos);
            yPos += 2;
          });
        }

        // Footer
        doc.setDrawColor(...primaryColor);
        doc.line(20, 285, 190, 285);
        doc.setFontSize(9);
        doc.setTextColor(255, 255, 255);
        doc.text("App Design and Developed by Tomstudio Tech Academy", 105, 290, null, null, "center");
        doc.text("+2348030827417", 105, 295, null, null, "center");

        // Save with fallbacks
        try {
          doc.save(`Performance_Report_${currentStaffId}_${today.replace(/\//g, '-')}.pdf`);
        } catch (e) {
          const pdfBlob = doc.output('blob');
          const url = URL.createObjectURL(pdfBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Performance_Report_${currentStaffId}_${today.replace(/\//g, '-')}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 100);
        }
      } catch (e) {
        console.error("PDF generation error:", e);
        alert("Could not generate PDF. Please try again.");
      }
    }

    // Utility: Download File
    function downloadFile(content, filename, mimeType) {
      try {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 100);
      } catch (e) {
        console.error("Download error:", e);
        alert("Could not download file. Please try again.");
      }
    }

    // Load all data
    function loadAllData() {
      try {
        clients = loadData('clients');
        staffActivities = loadData('staff');
        learningLogs = loadData('learning');
        sales = loadData('sales');
        students = loadData('students');
        finances = loadData('finances');
        galleryImages = loadData('gallery') || [];
        
        renderClients();
        renderStaff();
        renderLearning();
        renderSales();
        renderRegistrations();
        renderFinance();
        renderGallery();
        updateReportStats();
        displaySignInData();
      } catch (e) {
        console.error("Load all data error:", e);
        alert("Could not load data. Please try again.");
      }
    }

    // Initialize
    window.onload = function() {
      try {
        // Check if localStorage is available
        if (typeof localStorage === 'undefined') {
          alert("Your browser does not support local storage. Some features may not work.");
        }
        
        // Load any saved data
        loadAllData();
      } catch (e) {
        console.error("Initialization error:", e);
        alert("Application failed to initialize. Please refresh and try again.");
      }
    };

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      });
    }
  </script>
</body>
</html>