<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#6c5ce7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>TOMSTUDIO BIZ HUB - Task Manager</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.png" type="image/png">
  <link rel="apple-touch-icon" href="logo-192.png">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1200px;
      margin: 10px auto;
      padding: 15px;
    }

    /* Login Screen */
    .screen {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      overflow: hidden;
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #loginScreen {
      text-align: center;
      padding: 40px 20px;
    }

    #loginScreen img {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      border-radius: 50%;
      border: 4px solid #6c5ce7;
    }

    #loginScreen h1 {
      color: #6c5ce7;
      font-size: 2.2rem;
      margin-bottom: 8px;
    }

    #loginScreen h3 {
      color: #2d3436;
      margin-bottom: 15px;
      font-weight: 600;
    }

    #loginScreen p {
      color: #636e72;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    #loginScreen input {
      width: 100%;
      max-width: 300px;
      padding: 14px;
      margin: 12px auto;
      border: 2px solid #ddd;
      border-radius: 50px;
      font-size: 16px;
      text-align: center;
      display: block;
    }

    #loginScreen input:focus {
      border-color: #6c5ce7;
      outline: none;
      box-shadow: 0 0 10px rgba(108, 92, 231, 0.3);
    }

    #loginScreen button {
      background: linear-gradient(45deg, #6c5ce7, #a55eea);
      color: white;
      border: none;
      padding: 14px 35px;
      border-radius: 50px;
      font-size: 17px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
      margin-top: 10px;
    }

    #loginScreen button:hover {
      transform: translateY(-1px);
    }

    /* Main App */
    #mainApp {
      display: none;
      padding: 20px;
    }

    #mainApp img.mal {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #6c5ce7;
      margin: 0 auto 15px;
      display: block;
    }

    #mainApp h1 {
      text-align: center;
      color: #6c5ce7;
      margin-bottom: 8px;
      font-size: 1.8rem;
    }

    #mainApp h1 span {
      color: #2d3436;
      font-weight: 700;
    }

    #mainApp p {
      text-align: center;
      color: #636e72;
      margin-bottom: 25px;
      font-size: 1rem;
    }

    /* Sign In Section */
    .sign-in-info {
      background: linear-gradient(45deg, #00b894, #00cec9);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .sign-in-info h3 {
      margin-bottom: 12px;
      font-size: 1.4rem;
    }

    .sign-in-info p {
      margin: 8px 0;
      font-size: 1rem;
    }

    .time-location-btn {
      background: #2d3436;
      color: white;
      border: none;
      padding: 13px 25px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* Form */
    .form {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .form h3 {
      color: #6c5ce7;
      margin-bottom: 18px;
      text-align: center;
      font-size: 1.4rem;
    }

    .form input, .form textarea, .form select {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
    }

    .form input:focus, .form textarea:focus, .form select:focus {
      border-color: #6c5ce7;
      outline: none;
    }

    .form textarea {
      min-height: 90px;
      resize: vertical;
    }

    .form button {
      background: linear-gradient(45deg, #6c5ce7, #a55eea);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 10px;
      font-size: 17px;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
    }

    /* Client Section */
    .client-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin: 25px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .client-section h3 {
      color: #6c5ce7;
      margin-bottom: 18px;
      text-align: center;
      font-size: 1.4rem;
    }

    .client-entry {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #00b894;
    }

    .client-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .client-actions button {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .delete-client {
      background: #e17055;
      color: white;
    }

    /* Tasks List */
    h2 {
      color: #6c5ce7;
      margin: 25px 0 12px;
      font-size: 1.6rem;
    }

    #taskList {
      list-style: none;
    }

    #taskList li {
      background: white;
      padding: 18px;
      border-radius: 15px;
      margin-bottom: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      border-left: 5px solid #6c5ce7;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .task-name {
      font-weight: 700;
      font-size: 1.1rem;
      color: #2d3436;
    }

    .task-score {
      background: #6c5ce7;
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .task-desc, .task-comment {
      color: #636e72;
      margin: 6px 0;
      font-size: 0.9rem;
    }

    .task-comment {
      background: #fdcb6e;
      padding: 8px;
      border-radius: 6px;
      border-left: 3px solid #e17055;
    }

    .task-meta {
      display: flex;
      gap: 12px;
      font-size: 0.8rem;
      color: #636e72;
      margin-top: 8px;
    }

    .delete-btn {
      background: #e17055;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    /* Summary */
    .summary, .stats {
      background: linear-gradient(45deg, #74b9ff, #0984e3);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      text-align: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .summary h3, .stats h3 {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }

    .summary p, .stats p {
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Export */
    .export {
      display: flex;
      gap: 12px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    .export button {
      flex: 1;
      min-width: 140px;
      background: linear-gradient(45deg, #fd79a8, #e84393);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(236, 90, 159, 0.4);
    }

    /* Buttons */
    .clear-btn, .logout-btn {
      background: #2d3436;
      color: white;
      border: none;
      padding: 11px 22px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      margin: 8px 4px;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      color: white;
      font-size: 0.85rem;
      margin-top: 20px;
    }

    footer a {
      color: #fdcb6e;
      text-decoration: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 12px;
      }
      
      #loginScreen {
        padding: 30px 15px;
      }
      
      #loginScreen h1 {
        font-size: 1.8rem;
      }
      
      #mainApp {
        padding: 15px;
      }
      
      .export {
        flex-direction: column;
      }
      
      .export button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
      <img src="logo-192.png" alt="TOMSTUDIO Logo">
      <h1>TOMSTUDIO BIZ HUB</h1>
      <h3>DAILY TASK TRACKER</h3>
      <p>Please log in with your Staff ID</p>
      <input type="text" id="staffId" placeholder="Enter Staff ID" maxlength="10" />
      <button onclick="login()">üîì Log In</button>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="screen">
      <div style="text-align: center;">
        <img src="logo-192.png" alt="TOMSTUDIO Logo" class="mal">
      </div>
      
      <h1>üéØ Welcome, <span id="staffDisplay"></span>!</h1>
      <p>Track your tasks and performance.</p>

      <!-- Sign In Section -->
      <div class="sign-in-info">
        <h3>üìç Daily Sign In & Location</h3>
        <p id="signInTime">Not signed in</p>
        <p id="locationInfo">Location: Not tracked</p>
        <button class="time-location-btn" onclick="recordSignIn()">
          üïí Record Sign-In & GPS Coordinates
        </button>
      </div>

      <!-- Add Task Form -->
      <div class="form">
        <h3>‚ûï Add New Task</h3>
        <input type="text" id="taskName" placeholder="Task name" required />
        <textarea id="taskDesc" placeholder="Description (optional)"></textarea>
        <select id="taskScore" required>
          <option value="">Rate Task (1-10)</option>
          <option value="1">1 - Poor</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5 - Average</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10 - Excellent</option>
        </select>
        <textarea id="taskComment" placeholder="Explain why this task wasn't achieved (optional)"></textarea>
        <button onclick="addTask()">‚ûï Add Task</button>
      </div>

      <!-- Client/Visitor Section -->
      <div class="client-section">
        <h3>üìù Client/Visitor Details</h3>
        
        <!-- Add New Client Form -->
        <div style="background: #f1f2f6; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <input type="text" id="clientName" placeholder="Client Name" style="margin-bottom: 10px;" />
          <input type="text" id="clientPhone" placeholder="Phone Number" style="margin-bottom: 10px;" />
          <input type="email" id="clientEmail" placeholder="Email (optional)" style="margin-bottom: 10px;" />
          <textarea id="clientComment" placeholder="Client comments, inquiries, or feedback..." 
                    style="width: 100%; margin: 10px 0; padding: 12px; min-height: 80px; border-radius: 8px;"></textarea>
          <button onclick="addClient()" style="width: 100%; background: #00b894; padding: 12px;">‚úÖ Add Client</button>
        </div>

        <!-- Client List -->
        <div id="clientList" style="margin-top: 15px;">
          <!-- Client entries will be added here -->
        </div>
      </div>

      <!-- Daily Tasks List -->
      <h2>üìÖ Today's Tasks</h2>
      <ul id="taskList"></ul>

      <!-- Daily Summary -->
      <div class="summary">
        <h3>üìä Today's Score: <span id="dailyScore">0</span>/100</h3>
        <p>Average: <span id="dailyAvg">0</span></p>
      </div>

      <!-- Weekly & Monthly Stats -->
      <div class="stats">
        <h3>üìà Weekly Average: <span id="weeklyAvg">0</span></h3>
        <h3>üìÜ Monthly Average: <span id="monthlyAvg">0</span></h3>
      </div>

      <!-- Export Buttons -->
      <div class="export">
        <button onclick="exportToCSV()">üì• Export to CSV</button>
        <button onclick="generatePDF()">üìÑ Generate PDF Report</button>
      </div>

      <div style="text-align: center;">
        <button class="clear-btn" onclick="clearToday()">üóëÔ∏è Clear Today's Tasks</button>
        <button class="logout-btn" onclick="logout()">‚Ü©Ô∏è Logout</button>
      </div>
    </div>

    <footer>
      <p>&copy; <strong>App Design and Developed by Tomstudio Tech Academy</strong> | Contact: <a href="tel:+2348030827417">+2348030827417</a></p>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Global Variables
    let currentStaffId = null;
    let clients = [];
    let signInData = {};

    // DOM Elements
    const loginScreen = document.getElementById("loginScreen");
    const mainApp = document.getElementById("mainApp");
    const staffIdInput = document.getElementById("staffId");
    const staffDisplay = document.getElementById("staffDisplay");
    const signInTimeElement = document.getElementById("signInTime");
    const locationInfoElement = document.getElementById("locationInfo");
    const clientList = document.getElementById("clientList");

    // Login
    function login() {
      const id = staffIdInput.value.trim();
      if (!id) {
        alert("Please enter your Staff ID");
        return;
      }
      currentStaffId = id;
      staffDisplay.textContent = id;
      loginScreen.style.display = "none";
      mainApp.style.display = "block";
      loadAllData();
    }

    // Logout
    function logout() {
      if (confirm("Log out?")) {
        currentStaffId = null;
        loginScreen.style.display = "block";
        mainApp.style.display = "none";
        staffIdInput.value = "";
      }
    }

    // Record Sign-In Time and Location
    function recordSignIn() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const dateStr = now.toLocaleDateString();
      
      signInData = {
        time: timeStr,
        date: dateStr,
        timestamp: now.toISOString()
      };

      if (navigator.geolocation) {
        locationInfoElement.textContent = "üìç Getting GPS coordinates...";
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            signInData.location = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            
            locationInfoElement.innerHTML = `
              üìç <strong>Lat:</strong> ${position.coords.latitude.toFixed(6)}<br>
              üìç <strong>Lng:</strong> ${position.coords.longitude.toFixed(6)}<br>
              üìè <strong>Accuracy:</strong> ${position.coords.accuracy}m
            `;
            
            saveSignInData(signInData);
          },
          (error) => {
            console.log("Location error:", error);
            locationInfoElement.textContent = "üìç Location: Permission denied or unavailable";
            saveSignInData(signInData);
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
        );
      } else {
        locationInfoElement.textContent = "üìç Location: Not supported by browser";
        saveSignInData(signInData);
      }

      signInTimeElement.textContent = `Signed in at ${timeStr} on ${dateStr}`;
    }

    // Save sign-in data
    function saveSignInData(data) {
      localStorage.setItem(`signin_${currentStaffId}`, JSON.stringify(data));
    }

    // Display sign-in data
    function displaySignInData() {
      const saved = localStorage.getItem(`signin_${currentStaffId}`);
      if (saved) {
        const data = JSON.parse(saved);
        signInData = data;
        signInTimeElement.textContent = `Signed in at ${data.time} on ${data.date}`;
        if (data.location) {
          locationInfoElement.innerHTML = `
            üìç <strong>Lat:</strong> ${data.location.lat.toFixed(6)}<br>
            üìç <strong>Lng:</strong> ${data.location.lng.toFixed(6)}<br>
            üìè <strong>Accuracy:</strong> ${data.location.accuracy}m
          `;
        }
      }
    }

    // Get Keys
    function getTodayKey() {
      return `tasks_${currentStaffId}_${new Date().toISOString().split("T")[0]}`;
    }

    function getClientKey() {
      return `clients_${currentStaffId}_${new Date().toISOString().split("T")[0]}`;
    }

    // Load tasks
    function loadTasks() {
      const saved = localStorage.getItem(getTodayKey());
      return saved ? JSON.parse(saved) : [];
    }

    // Save tasks
    function saveTasks(tasks) {
      localStorage.setItem(getTodayKey(), JSON.stringify(tasks));
      updateDailyStats(tasks);
      updateWeeklyMonthlyStats();
    }

    // Add Task
    function addTask() {
      const name = document.getElementById("taskName").value.trim();
      const desc = document.getElementById("taskDesc").value.trim();
      const score = parseInt(document.getElementById("taskScore").value);
      const comment = document.getElementById("taskComment").value.trim();

      if (!name || isNaN(score)) {
        alert("Please enter task name and score.");
        return;
      }

      const tasks = loadTasks();
      const now = new Date();
      
      tasks.push({
        id: Date.now(),
        name,
        desc,
        score,
        comment: comment || null,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      });

      saveTasks(tasks);
      renderTasks();
      clearForm();
    }

    // Render Tasks
    function renderTasks() {
      const tasks = loadTasks();
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";

      tasks.forEach(task => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="task-header">
            <span class="task-name">${task.name}</span>
            <span class="task-score">${task.score}/10</span>
          </div>
          ${task.desc ? `<p class="task-desc">${task.desc}</p>` : ""}
          ${task.comment ? `<div class="task-comment">üí¨ ${task.comment}</div>` : ""}
          <div class="task-meta">
            <span>üìÖ ${task.date}</span>
            <span>‚è∞ ${task.time}</span>
          </div>
        `;
        
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = () => deleteTask(task.id);
        
        li.appendChild(deleteBtn);
        taskList.appendChild(li);
      });
    }

    // Delete Task
    function deleteTask(id) {
      let tasks = loadTasks();
      tasks = tasks.filter(t => t.id !== id);
      saveTasks(tasks);
      renderTasks();
    }

    // Update Daily Stats
    function updateDailyStats(tasks) {
      const total = tasks.reduce((sum, t) => sum + t.score, 0);
      const avg = tasks.length > 0 ? (total / tasks.length).toFixed(2) : "0";

      document.getElementById("dailyScore").textContent = total;
      document.getElementById("dailyAvg").textContent = avg;
    }

    // Update Weekly & Monthly Averages
    function updateWeeklyMonthlyStats() {
      const allKeys = Object.keys(localStorage);
      let weeklyScores = [];
      let monthlyScores = [];

      const todayPrefix = getTodayKey().split("_").slice(0, 3).join("_");

      allKeys.forEach(key => {
        if (key.startsWith(todayPrefix)) {
          const tasks = JSON.parse(localStorage.getItem(key));
          const avgScore = tasks.length > 0 ? tasks.reduce((a, b) => a + b.score, 0) / tasks.length : 0;

          if (key.startsWith(`week_${currentStaffId}`)) {
            weeklyScores.push(avgScore);
          }
          if (key.startsWith(`month_${currentStaffId}`)) {
            monthlyScores.push(avgScore);
          }
        }
      });

      const weeklyAvg = weeklyScores.length > 0
        ? (weeklyScores.reduce((a, b) => a + b, 0) / weeklyScores.length).toFixed(2)
        : "0";

      const monthlyAvg = monthlyScores.length > 0
        ? (monthlyScores.reduce((a, b) => a + b, 0) / monthlyScores.length).toFixed(2)
        : "0";

      document.getElementById("weeklyAvg").textContent = weeklyAvg;
      document.getElementById("monthlyAvg").textContent = monthlyAvg;
    }

    // Add Client
    function addClient() {
      const name = document.getElementById("clientName").value.trim();
      const phone = document.getElementById("clientPhone").value.trim();
      const email = document.getElementById("clientEmail").value.trim();
      const comment = document.getElementById("clientComment").value.trim();

      if (!name) {
        alert("Please enter client name");
        return;
      }

      const now = new Date();
      const client = {
        id: Date.now(),
        name,
        phone,
        email,
        comment,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };

      clients.push(client);
      saveClients();
      renderClients();
      clearClientForm();
    }

    // Save Clients
    function saveClients() {
      localStorage.setItem(getClientKey(), JSON.stringify(clients));
    }

    // Render Clients
    function renderClients() {
      clientList.innerHTML = "";
      
      if (clients.length === 0) {
        clientList.innerHTML = "<p>No clients recorded today.</p>";
        return;
      }

      clients.forEach(client => {
        const div = document.createElement("div");
        div.className = "client-entry";
        div.innerHTML = `
          <strong>${client.name}</strong>
          ${client.phone ? `<div>üìû ${client.phone}</div>` : ""}
          ${client.email ? `<div>‚úâÔ∏è ${client.email}</div>` : ""}
          ${client.comment ? `<div class="task-comment">üí¨ ${client.comment}</div>` : ""}
          <div class="task-meta">
            <span>üìÖ ${client.date}</span>
            <span>‚è∞ ${client.time}</span>
          </div>
        `;
        
        const actions = document.createElement("div");
        actions.className = "client-actions";
        
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è Delete";
        deleteBtn.className = "delete-client";
        deleteBtn.onclick = () => deleteClient(client.id);
        
        actions.appendChild(deleteBtn);
        div.appendChild(actions);
        clientList.appendChild(div);
      });
    }

    // Delete Client
    function deleteClient(id) {
      clients = clients.filter(c => c.id !== id);
      saveClients();
      renderClients();
    }

    // Clear Client Form
    function clearClientForm() {
      document.getElementById("clientName").value = "";
      document.getElementById("clientPhone").value = "";
      document.getElementById("clientEmail").value = "";
      document.getElementById("clientComment").value = "";
    }

    // Load Clients
    function loadClients() {
      const saved = localStorage.getItem(getClientKey());
      if (saved) {
        clients = JSON.parse(saved);
        renderClients();
      }
    }

    // Export to CSV
    function exportToCSV() {
      const tasks = loadTasks();
      if (tasks.length === 0 && clients.length === 0) {
        alert("No data to export.");
        return;
      }

      let csv = "Staff,Date,Sign-In,Lat,Lng,Accuracy,Task,Desc,Score,Comment,Client,ClientPhone,ClientEmail,ClientComment\n";
      const date = new Date().toISOString().split("T")[0];
      const signIn = signInData.time || 'Not recorded';
      const lat = signInData.location ? signInData.location.lat.toFixed(6) : '';
      const lng = signInData.location ? signInData.location.lng.toFixed(6) : '';
      const accuracy = signInData.location ? signInData.location.accuracy : '';

      // Add tasks
      tasks.forEach(t => {
        csv += `${currentStaffId},${date},"${signIn}","${lat}","${lng}","${accuracy}","${t.name}","${t.desc}","${t.score}","${t.comment || ''}","","","",""\n`;
      });

      // Add clients
      clients.forEach(c => {
        csv += `${currentStaffId},${date},"${signIn}","${lat}","${lng}","${accuracy}","","","","","${c.name}","${c.phone || ''}","${c.email || ''}","${c.comment || ''}"\n`;
      });

      downloadFile(csv, `report_${currentStaffId}_${date}.csv`, "text/csv");
    }

    // Generate Comprehensive PDF Report - VERIFIED VERSION
    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      const tasks = loadTasks();
      const today = new Date().toLocaleDateString();
      const dailyScore = document.getElementById("dailyScore").textContent;
      const dailyAvg = document.getElementById("dailyAvg").textContent;
      const weeklyAvg = document.getElementById("weeklyAvg").textContent;
      const monthlyAvg = document.getElementById("monthlyAvg").textContent;

      // Set colors
      const primaryColor = [108, 92, 231]; // #6c5ce7
      const textColor = [66, 66, 66];

      // Header
      doc.setFillColor(...primaryColor);
      doc.rect(0, 0, 210, 40, 'F'); // Background
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.text("TOMSTUDIO BIZ HUB", 105, 20, null, null, "center");
      doc.setFontSize(14);
      doc.text("Daily Performance Report", 105, 30, null, null, "center");

      // Reset color
      doc.setTextColor(...textColor);

      // Staff Info - Section 1
      let yPos = 50;
      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text("STAFF INFORMATION", 15, yPos);
      yPos += 8;
      doc.setFont("helvetica", "normal");
      doc.text(`Staff ID: ${currentStaffId}`, 15, yPos);
      yPos += 6;
      doc.text(`Date: ${today}`, 15, yPos);
      yPos += 6;
      doc.text(`Sign-In: ${signInData.time || 'Not recorded'}`, 15, yPos);
      yPos += 10;

      // Location Info
      if (signInData.location) {
        doc.setFont("helvetica", "bold");
        doc.text("GPS LOCATION", 15, yPos);
        yPos += 8;
        doc.setFont("helvetica", "normal");
        doc.text(`Latitude: ${signInData.location.lat.toFixed(6)}`, 15, yPos);
        yPos += 6;
        doc.text(`Longitude: ${signInData.location.lng.toFixed(6)}`, 15, yPos);
        yPos += 6;
        doc.text(`Accuracy: ${signInData.location.accuracy}m`, 15, yPos);
        yPos += 10;
      }

      // Client Info
      if (clients.length > 0) {
        doc.setFont("helvetica", "bold");
        doc.text("CLIENT/VISITOR DETAILS", 15, yPos);
        yPos += 8;
        
        clients.forEach(client => {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFont("helvetica", "bold");
          doc.text(`Name: ${client.name}`, 15, yPos);
          yPos += 6;
          doc.setFont("helvetica", "normal");
          
          if (client.phone) {
            doc.text(`Phone: ${client.phone}`, 15, yPos);
            yPos += 5;
          }
          if (client.email) {
            doc.text(`Email: ${client.email}`, 15, yPos);
            yPos += 5;
          }
          if (client.comment) {
            doc.text("Comments:", 15, yPos);
            yPos += 5;
            const commentLines = doc.splitTextToSize(client.comment, 170);
            commentLines.forEach(line => {
              if (yPos > 270) {
                doc.addPage();
                yPos = 20;
              }
              doc.text(line, 15, yPos);
              yPos += 5;
            });
            yPos += 2;
          }
          
          doc.text(`Date: ${client.date} | Time: ${client.time}`, 15, yPos);
          yPos += 8;
        });
        
        yPos += 5;
      }

      // Performance Summary
      doc.setFont("helvetica", "bold");
      doc.text("PERFORMANCE SUMMARY", 15, yPos);
      yPos += 8;
      doc.setFont("helvetica", "normal");
      doc.text(`Today's Score: ${dailyScore}/100`, 15, yPos);
      yPos += 6;
      doc.text(`Average: ${dailyAvg}`, 15, yPos);
      yPos += 6;
      doc.text(`Weekly Average: ${weeklyAvg}`, 15, yPos);
      yPos += 6;
      doc.text(`Monthly Average: ${monthlyAvg}`, 15, yPos);
      yPos += 10;

      // Tasks Table
      if (tasks.length > 0) {
        doc.setFont("helvetica", "bold");
        doc.text("TODAY'S TASKS", 15, yPos);
        yPos += 8;
        
        const tableData = tasks.map(t => [
          t.name,
          t.desc || "-",
          t.score.toString(),
          t.comment || "-"
        ]);
        
        try {
          doc.autoTable({
            startY: yPos,
            head: [['Task', 'Description', 'Score', 'Comment']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
              fillColor: primaryColor,
              textColor: [255, 255, 255],
              fontSize: 10
            },
            bodyStyles: { 
              fontSize: 9
            },
            styles: {
              font: 'helvetica',
              fontSize: 10
            },
            columnStyles: {
              0: { cellWidth: 50 },
              1: { cellWidth: 60 },
              2: { cellWidth: 20 },
              3: { cellWidth: 60 }
            }
          });
        } catch (e) {
          console.error("AutoTable error:", e);
          yPos = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : yPos;
          doc.text("Task data could not be displayed in table format.", 15, yPos);
        }
      }

      // Footer
      const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : yPos + 20;
      doc.setDrawColor(...primaryColor);
      doc.line(15, finalY, 195, finalY);
      doc.setFontSize(9);
      doc.setTextColor(...textColor);
      doc.text("App Design and Developed by Tomstudio Tech Academy", 15, finalY + 10);
      doc.text("+2348030827417", 15, finalY + 15);

      // Finalize and save with multiple fallbacks
      try {
        // Method 1: Direct save
        doc.save(`TOMSTUDIO_Report_${currentStaffId}_${today.replace(/\//g, '-')}.pdf`);
      } catch (e) {
        console.error("Save failed:", e);
        
        // Method 2: Blob + download
        try {
          const pdfBlob = doc.output('blob');
          const url = URL.createObjectURL(pdfBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `TOMSTUDIO_Report_${currentStaffId}_${today.replace(/\//g, '-')}.pdf`;
          
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 100);
        } catch (e2) {
          console.error("Fallback save failed:", e2);
          
          // Method 3: Open in new tab
          try {
            const url = doc.output('datauristring');
            const newTab = window.open();
            newTab.document.write(`<iframe width="100%" height="100%" src="${url}"></iframe>`);
          } catch (e3) {
            alert("Could not generate PDF. Please try again.");
            console.error("All methods failed:", e3);
          }
        }
      }
    }

    // Utility: Download File
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Clear Form
    function clearForm() {
      document.getElementById("taskName").value = "";
      document.getElementById("taskDesc").value = "";
      document.getElementById("taskScore").value = "";
      document.getElementById("taskComment").value = "";
    }

    // Clear today's tasks
    function clearToday() {
      if (confirm("Are you sure you want to clear all data for today?")) {
        localStorage.removeItem(getTodayKey());
        localStorage.removeItem(getClientKey());
        renderTasks();
        clients = [];
        renderClients();
        updateDailyStats([]);
        updateWeeklyMonthlyStats();
      }
    }

    // Load all data
    function loadAllData() {
      renderTasks();
      updateWeeklyMonthlyStats();
      displaySignInData();
      loadClients();
    }

    // Initialize
    window.onload = function() {
      const savedSignIn = localStorage.getItem('tomstudio_signIn');
      if (savedSignIn) {
        signInData = JSON.parse(savedSignIn);
      }
    };

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      });
    }
  </script>
</body>
</html>
