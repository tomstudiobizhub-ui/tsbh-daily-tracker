<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#6c5ce7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="description" content="Tomstudio Daily Performance Tracker - Full PWA with Image Support">
  <meta name="format-detection" content="telephone=no">
  <title>TOMSTUDIO DAILY PERFORMANCE TRACKER</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.png" type="image/png">
  <link rel="apple-touch-icon" href="logo-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="logo-512.png">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <style>
    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }
    .container {
      max-width: 1200px;
      margin: 10px auto;
      padding: 15px;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(108, 92, 231, 0); }
      100% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0); }
    }

    /* Login Screen */
    .screen {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      overflow: hidden;
      animation: fadeIn 0.6s ease;
      min-height: 500px;
    }
    #loginScreen {
      text-align: center;
      padding: 40px 20px;
    }
    #loginScreen img {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      border-radius: 50%;
      border: 4px solid #6c5ce7;
      animation: pulse 2s infinite;
    }
    #loginScreen h1 {
      color: #6c5ce7;
      font-size: 2.2rem;
      margin-bottom: 8px;
      font-weight: 700;
    }
    #loginScreen h3 {
      color: #2d3436;
      margin-bottom: 15px;
      font-weight: 600;
    }
    #loginScreen p {
      color: #636e72;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }
    #loginScreen input {
      width: 100%;
      max-width: 300px;
      padding: 14px;
      margin: 12px auto;
      border: 2px solid #ddd;
      border-radius: 50px;
      font-size: 16px;
      text-align: center;
      display: block;
      transition: border 0.3s;
    }
    #loginScreen input:focus {
      border-color: #6c5ce7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }
    #loginScreen button {
      background: linear-gradient(45deg, #6c5ce7, #a55eea);
      color: white;
      border: none;
      padding: 14px 35px;
      border-radius: 50px;
      font-size: 17px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
      margin-top: 10px;
      transition: transform 0.2s;
    }
    #loginScreen button:hover {
      transform: translateY(-2px);
    }

    /* Navigation */
    nav {
      background: white;
      border-radius: 15px;
      padding: 5px;
      margin: 15px 0;
      display: flex;
      overflow-x: auto;
      gap: 2px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      scrollbar-width: thin;
    }
    nav a {
      display: block;
      padding: 12px 20px;
      color: #636e72;
      text-decoration: none;
      font-weight: 600;
      border-radius: 10px;
      white-space: nowrap;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    nav a.active {
      background: #6c5ce7;
      color: white;
      box-shadow: 0 3px 10px rgba(108, 92, 231, 0.4);
    }
    nav a:hover:not(.active) {
      background: #f1f2f6;
      color: #2d3436;
    }

    /* Main App */
    #mainApp {
      display: none;
      padding: 20px;
    }
    #mainApp img.mal {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #6c5ce7;
      margin: 0 auto 15px;
      display: block;
      animation: pulse 2s infinite;
    }
    #mainApp h1 {
      text-align: center;
      color: #6c5ce7;
      margin-bottom: 8px;
      font-size: 1.8rem;
      font-weight: 700;
    }
    #mainApp h1 span {
      color: #2d3436;
      font-weight: 700;
    }
    #mainApp p {
      text-align: center;
      color: #636e72;
      margin-bottom: 25px;
      font-size: 1rem;
    }

    /* Sign In Section */
    .sign-in-info {
      background: linear-gradient(45deg, #00b894, #00cec9);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .sign-in-info h3 {
      margin-bottom: 12px;
      font-size: 1.4rem;
    }
    .sign-in-info p {
      margin: 8px 0;
      font-size: 1rem;
    }
    .time-location-btn {
      background: #2d3436;
      color: white;
      border: none;
      padding: 13px 25px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    .time-location-btn:hover {
      background: #1e272e;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    /* Form */
    .form {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .form h3 {
      color: #6c5ce7;
      margin-bottom: 18px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 600;
    }
    .form input,
    .form textarea,
    .form select {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      transition: border 0.3s;
    }
    .form input:focus,
    .form textarea:focus,
    .form select:focus {
      border-color: #6c5ce7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
    }
    .form textarea {
      min-height: 90px;
      resize: vertical;
    }
    .form button {
      background: linear-gradient(45deg, #6c5ce7, #a55eea);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 10px;
      font-size: 17px;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
      transition: transform 0.2s;
    }
    .form button:hover {
      transform: translateY(-2px);
    }

    /* Image Upload */
    .image-upload {
      border: 2px dashed #ddd;
      padding: 20px;
      text-align: center;
      margin: 15px 0;
      border-radius: 10px;
      background: #fdfdfd;
      transition: border 0.3s;
    }
    .image-upload:hover {
      border-color: #6c5ce7;
      background: #f8f9ff;
    }
    .image-upload p {
      margin-bottom: 10px;
      color: #636e72;
    }
    .image-preview {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
      margin: 10px 0;
    }
    .image-item {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      border: 2px solid #ddd;
    }
    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-item .delete-img {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(225, 112, 85, 0.9);
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-item .delete-img:hover {
      background: #e84393;
    }

    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    .gallery-item {
      position: relative;
      height: 150px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #ddd;
    }
    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .gallery-item .delete-img {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(225, 112, 85, 0.9);
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Export */
    .export {
      display: flex;
      gap: 12px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    .export button {
      flex: 1;
      min-width: 140px;
      background: linear-gradient(45deg, #fd79a8, #e84393);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(236, 90, 159, 0.4);
      transition: transform 0.2s;
    }
    .export button:hover {
      transform: translateY(-2px);
    }

    /* Buttons */
    .clear-btn,
    .logout-btn {
      background: #2d3436;
      color: white;
      border: none;
      padding: 11px 22px;
      border-radius: 50px;
      font-size: 15px;
      cursor: pointer;
      margin: 8px 4px;
      transition: background 0.3s;
    }
    .clear-btn:hover,
    .logout-btn:hover {
      background: #1e272e;
    }

    /* Summary Cards */
    .summary-box {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .summary-card {
      flex: 1;
      min-width: 200px;
      background: #f1f2f6;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .summary-card h4 {
      font-size: 0.9rem;
      color: #636e72;
      margin-bottom: 5px;
    }
    .summary-card p {
      font-size: 1.4rem;
      font-weight: bold;
      color: #2d3436;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 30px;
      color: white;
      font-size: 0.9rem;
      margin-top: 30px;
      font-weight: 600;
    }
    footer a {
      color: #fdcb6e;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 12px;
      }
      #loginScreen {
        padding: 30px 15px;
      }
      #loginScreen h1 {
        font-size: 1.8rem;
      }
      #mainApp {
        padding: 15px;
      }
      .export {
        flex-direction: column;
      }
      .export button {
        width: 100%;
      }
      .summary-box {
        flex-direction: column;
      }
      nav {
        font-size: 0.9rem;
      }
    }

    /* Print Styles */
    @media print {
      body, .container {
        background: white !important;
        -webkit-print-color-adjust: exact;
      }
      .no-print, nav, .form, .image-upload, .clear-btn, .logout-btn {
        display: none !important;
      }
      .tab-content {
        display: block !important;
      }
    }

    /* Loading Spinner */
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #6c5ce7;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2d3436;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      transform: translateY(-50px);
      transition: all 0.4s;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Toast Notification -->
    <div id="toast" class="toast">Action completed!</div>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
      <img src="logo-192.png" alt="TOMSTUDIO Logo">
      <h1>TOMSTUDIO DAILY PERFORMANCE TRACKER</h1>
      <h3>COMPLETE OFFICE/FIELD OPERATIONS</h3>
      <p>Please log in with your Staff ID</p>
      <input type="text" id="staffId" placeholder="Enter Staff ID" maxlength="20" />
      <button onclick="login()">üîì Log In</button>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="screen">
      <div style="text-align: center;">
        <img src="logo-192.png" alt="TOMSTUDIO Logo" class="mal">
      </div>
      <h1>üéØ Welcome, <span id="staffDisplay"></span>!</h1>
      <p>Track your daily performance and activities.</p>

      <!-- Sign In Section -->
      <div class="sign-in-info">
        <h3>üìç Daily Sign In & GPS Location</h3>
        <p id="signInTime">Not signed in</p>
        <p id="locationInfo">Location: Not tracked</p>
        <button class="time-location-btn" onclick="recordSignIn()">
          üïí Record Sign-In & Get GPS Coordinates
        </button>
      </div>

      <!-- Navigation Tabs -->
      <nav>
        <a href="#" class="tab-link active" data-tab="clients">Clients/Visitors</a>
        <a href="#" class="tab-link" data-tab="staff">Onsite Staff</a>
        <a href="#" class="tab-link" data-tab="learning">CBT Schl/Students </a>
        <a href="#" class="tab-link" data-tab="sales">Daily Sales</a>
        <a href="#" class="tab-link" data-tab="registration">New Students</a>
        <a href="#" class="tab-link" data-tab="finance">Income & Expenses</a>
        <a href="#" class="tab-link" data-tab="gallery">Class Gallery</a>
        <a href="#" class="tab-link" data-tab="reports">Reports</a>
      </nav>

      <!-- Clients/Visitors Tab -->
      <section id="clients" class="tab-content active">
        <div class="form">
          <h3>üìù Client/Visitor Details</h3>
          <input type="text" id="clientName" placeholder="Client Name" />
          <input type="text" id="clientPhone" placeholder="Phone Number" />
          <input type="email" id="clientEmail" placeholder="Email (optional)" />
          <textarea id="clientComment" placeholder="Purpose of visit, feedback, or comments..."></textarea>
          <button onclick="addClient()">‚úÖ Add Client</button>
          <button onclick="clearClients()" class="clear-btn" style="width:auto; margin-top:10px;">üóëÔ∏è Clear All</button>
        </div>
        <div id="clientList"></div>
      </section>

      <!-- Onsite Staff Tab -->
      <section id="staff" class="tab-content">
        <div class="form">
          <h3>üë∑ Onsite Staff Daily Tasks</h3>
          <input type="text" id="staffName" placeholder="Staff Name" />
          <select id="staffRole">
            <option value="">Select Role</option>
            <option value="Teacher">Manager</option>
            <option value="Teacher">Executive Director</option>
            <option value="Teacher">Acting Manager</option>
            <option value="Cleaner">Tech Coach</option>
            <option value="Cleaner">CBT Coach</option>
            <option value="Security">Students</option>
            <option value="Security">Photographer</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Admin">Admin</option>
            <option value="Admin">Special personnel</option>
            <option value="Admin">Other personnel</option>
          </select>
          <textarea id="staffActivity" placeholder="Daily activities and tasks completed..."></textarea>
          <div class="image-upload">
            <p>üì∏ Upload Activity Photos</p>
            <input type="file" id="staffPhotos" accept="image/" multiple>
          </div>
          <div class="image-preview" id="staffPhotoPreview"></div>
          <button onclick="addStaffActivity()">‚úÖ Record Activity</button>
          <button onclick="clearStaff()" class="clear-btn" style="width:auto; margin-top:10px;">üóëÔ∏è Clear All</button>
        </div>
        <div id="staffList"></div>
      </section>

      <!-- Student Learning Tab -->
      <section id="learning" class="tab-content">
        <div class="form">
          <h3>üìö Student Learning Log</h3>
          <input type="text" id="className" placeholder="Class Name (e.g., Primary 3)" />
          <textarea id="topicsCovered" placeholder="Topics covered today..."></textarea>
          <textarea id="studentProgress" placeholder="Student progress and challenges..."></textarea>
          <div class="image-upload">
            <p>üì∏ Upload Class Activity Photos</p>
            <input type="file" id="learningPhotos" accept="image/" multiple>
          </div>
          <div class="image-preview" id="learningPhotoPreview"></div>
          <button onclick="addLearningLog()">‚úÖ Record Learning</button>
          <button onclick="clearLearning()" class="clear-btn" style="width:auto; margin-top:10px;">üóëÔ∏è Clear All</button>
        </div>
        <div id="learningList"></div>
      </section>

      <!-- Daily Sales Tab -->
      <section id="sales" class="tab-content">
        <div class="form">
          <h3>üí∞ Daily Sales</h3>
          <input type="text" id="saleItem" placeholder="Item Sold" />
          <input type="number" id="saleAmount" placeholder="Amount (‚Ç¶)" />
          <textarea id="saleNotes" placeholder="Additional notes..."></textarea>
          <button onclick="addSale()">‚úÖ Record Sale</button>
          <button onclick="clearSales()" class="clear-btn" style="width:auto; margin-top:10px;">üóëÔ∏è Clear All</button>
        </div>
        <div id="salesList"></div>
        <div style="background:white; padding:15px; border-radius:10px; margin:15px 0;">
          <h4>üí∞ Today's Total Sales: <span id="dailySalesTotal">‚Ç¶0</span></h4>
        </div>
      </section>

      <!-- New Student Registration -->
      <section id="registration" class="tab-content">
        <div class="form">
          <h3>üéì New Student Registration</h3>
          <input type="text" id="studentName" placeholder="Student Name" />
          <input type="text" id="studentAge" placeholder="Age" />
          <input type="text" id="studentClass" placeholder="Class" />
          <input type="text" id="parentName" placeholder="Parent/Guardian Name" />
          <input type="text" id="parentPhone" placeholder="Parent Phone" />
          <textarea id="studentNotes" placeholder="Additional information..."></textarea>
          <button onclick="registerStudent()">‚úÖ Register Student</button>
          <button onclick="clearRegistrations()" class="clear-btn" style="width:auto; margin-top:10px;">üóëÔ∏è Clear All</button>
        </div>
        <div id="registrationList"></div>
      </section>

      <!-- Income & Expenses -->
      <section id="finance" class="tab-content">
        <div class="form">
          <h3>üìä Income & Expenses</h3>
          <select id="financeType">
            <option value="">Select Type</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <input type="text" id="financeItem" placeholder="Item/Description" />
          <input type="number" id="financeAmount" placeholder="Amount (‚Ç¶)" />
          <textarea id="financeNotes" placeholder="Additional notes..."></textarea>
          <button onclick="addFinance()">‚úÖ Record Transaction</button>
          <button onclick="clearFinance()" class="clear-btn" style="width:auto; margin-top:10px;">üóëÔ∏è Clear All</button>
        </div>
        <div id="financeList"></div>
        <div style="background:white; padding:15px; border-radius:10px; margin:15px 0;">
          <h4>üìä Today's Summary:</h4>
          <p>Income: <span id="totalIncome">‚Ç¶0</span> | Expenses: <span id="totalExpenses">‚Ç¶0</span> | Net: <span id="netBalance">‚Ç¶0</span></p>
        </div>
      </section>

      <!-- Class Gallery Tab -->
      <section id="gallery" class="tab-content">
        <h2>üñºÔ∏è Class Gallery</h2>
        <button onclick="clearGallery()" class="clear-btn" style="margin:10px 0;">üóëÔ∏è Clear All Images</button>
        <div class="gallery" id="galleryImages"></div>
      </section>

      <!-- Reports Tab -->
      <section id="reports" class="tab-content">
        <h2>üìÑ Comprehensive Reports</h2>
        <div class="export">
          <button onclick="generatePDF()">üìÑ Generate PDF Report (with Images)</button>
          <button onclick="exportToCSV()">üì• Export to CSV</button>
          <button onclick="backupData()">‚òÅÔ∏è Backup to Cloud</button>
        </div>
        <div class="summary-box" style="margin: 20px 0;">
          <div class="summary-card">
            <h4>Clients</h4>
            <p id="clientCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Staff</h4>
            <p id="staffCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Learning</h4>
            <p id="learningCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Sales</h4>
            <p id="salesCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Students</h4>
            <p id="studentCount">0</p>
          </div>
          <div class="summary-card">
            <h4>Transactions</h4>
            <p id="financeCount">0</p>
          </div>
        </div>
      </section>

      <div style="text-align: center; margin-top: 20px;">
        <button class="logout-btn" onclick="logout()">‚Ü©Ô∏è Logout</button>
      </div>
    </div>

    <footer>
      &copy; <strong>App Design and Developed by Tomstudio Tech Academy</strong> | Contact: <a href="tel:+2348030827417">+2348030827417</a>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script>
    // ========================
    // 1. GLOBAL VARIABLES
    // ========================
    let currentStaffId = null;
    let clients = [];
    let staffActivities = [];
    let learningLogs = [];
    let sales = [];
    let students = [];
    let finances = [];
    let galleryImages = [];
    let signInData = {};
    let unsavedChanges = false;
    let isOnline = navigator.onLine;

    // DOM Elements
    const loginScreen = document.getElementById("loginScreen");
    const mainApp = document.getElementById("mainApp");
    const staffIdInput = document.getElementById("staffId");
    const staffDisplay = document.getElementById("staffDisplay");
    const signInTimeElement = document.getElementById("signInTime");
    const locationInfoElement = document.getElementById("locationInfo");
    const toast = document.getElementById("toast");

    // ========================
    // 2. UTILITY FUNCTIONS
    // ========================
    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, duration);
    }

    function getTodayKey(prefix) {
      return `${prefix}_${currentStaffId}_${new Date().toISOString().split("T")[0]}`;
    }

    function getAllKeys(prefix) {
      return Object.keys(localStorage).filter(k => k.startsWith(prefix + "_"));
    }

    function saveData(key, data) {
      try {
        localStorage.setItem(getTodayKey(key), JSON.stringify(data));
        unsavedChanges = true;
        showToast(`${key} saved!`);
      } catch (e) {
        console.error("Storage error:", e);
        showToast("Could not save data. Storage full?");
      }
    }

    function loadData(key) {
      try {
        const saved = localStorage.getItem(getTodayKey(key));
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error("Load error:", e);
        return [];
      }
    }

    function clearForm(fieldIds) {
      fieldIds.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.type === 'file') {
          element.value = '';
          if (id === 'staffPhotos') document.getElementById('staffPhotoPreview').innerHTML = '';
          if (id === 'learningPhotos') document.getElementById('learningPhotoPreview').innerHTML = '';
        } else if (element) {
          element.value = '';
        }
      });
    }

    // ========================
    // 3. LOGIN & LOGOUT
    // ========================
    function login() {
      const id = staffIdInput.value.trim();
      if (!id) {
        alert("Please enter your Staff ID");
        return;
      }
      currentStaffId = id;
      staffDisplay.textContent = id;
      loginScreen.style.display = "none";
      mainApp.style.display = "block";
      loadAllData();
      showToast(`Welcome, ${id}!`);
    }

    function logout() {
      if (confirm("Log out?")) {
        currentStaffId = null;
        loginScreen.style.display = "block";
        mainApp.style.display = "none";
        staffIdInput.value = "";
        showToast("Logged out.");
      }
    }

    // ========================
    // 4. GPS & SIGN IN
    // ========================
    function recordSignIn() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const dateStr = now.toLocaleDateString();
      signInData = {
        time: timeStr,
        date: dateStr,
        timestamp: now.toISOString()
      };

      if (navigator.geolocation) {
        locationInfoElement.innerHTML = '<div class="loader"></div>';
        navigator.geolocation.getCurrentPosition(
          (position) => {
            signInData.location = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            locationInfoElement.innerHTML = `
              üìç <strong>Latitude:</strong> ${position.coords.latitude.toFixed(6)}<br>
              üìç <strong>Longitude:</strong> ${position.coords.longitude.toFixed(6)}<br>
              üìè <strong>Accuracy:</strong> ${position.coords.accuracy}m
            `;
            saveSignInData(signInData);
            showToast("GPS location recorded!");
          },
          (error) => {
            console.log("Location error:", error);
            locationInfoElement.textContent = "üìç Location: Permission denied or unavailable";
            saveSignInData(signInData);
            showToast("Could not get GPS.");
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
        );
      } else {
        locationInfoElement.textContent = "üìç Location: Not supported by browser";
        saveSignInData(signInData);
      }
      signInTimeElement.textContent = `Signed in at ${timeStr} on ${dateStr}`;
    }

    function saveSignInData(data) {
      try {
        localStorage.setItem(`signin_${currentStaffId}`, JSON.stringify(data));
      } catch (e) {
        console.error("Storage error:", e);
      }
    }

    function displaySignInData() {
      const saved = localStorage.getItem(`signin_${currentStaffId}`);
      if (saved) {
        const data = JSON.parse(saved);
        signInData = data;
        signInTimeElement.textContent = `Signed in at ${data.time} on ${data.date}`;
        if (data.location) {
          locationInfoElement.innerHTML = `
            üìç <strong>Latitude:</strong> ${data.location.lat.toFixed(6)}<br>
            üìç <strong>Longitude:</strong> ${data.location.lng.toFixed(6)}<br>
            üìè <strong>Accuracy:</strong> ${data.location.accuracy}m
          `;
        }
      }
    }

    // ========================
    // 5. TAB NAVIGATION
    // ========================
    document.querySelectorAll('.tab-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = link.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        link.classList.add('active');

        if (tabId === 'clients') renderClients();
        if (tabId === 'staff') renderStaff();
        if (tabId === 'learning') renderLearning();
        if (tabId === 'sales') renderSales();
        if (tabId === 'registration') renderRegistrations();
        if (tabId === 'finance') renderFinance();
        if (tabId === 'gallery') renderGallery();
        if (tabId === 'reports') updateReportStats();
      });
    });

    // ========================
    // 6. DATA RENDERING
    // ========================
    function renderClients() {
      const list = document.getElementById("clientList");
      list.innerHTML = "";
      if (clients.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No clients recorded today.</p>";
        return;
      }
      clients.forEach(client => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #00b894;";
        div.innerHTML = `
          <strong>${client.name}</strong>
          ${client.phone ? `<div>üìû ${client.phone}</div>` : ""}
          ${client.email ? `<div>‚úâÔ∏è ${client.email}</div>` : ""}
          ${client.comment ? `<div style="color:#636e72; margin:8px 0;">üí¨ ${client.comment}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            üìÖ ${client.date} | ‚è∞ ${client.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    function renderStaff() {
      const list = document.getElementById("staffList");
      list.innerHTML = "";
      if (staffActivities.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No staff activities recorded today.</p>";
        return;
      }
      staffActivities.forEach(staff => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #0984e3;";
        div.innerHTML = `
          <strong>${staff.name} (${staff.role})</strong>
          <div style="color:#636e72; margin:8px 0;">${staff.activity}</div>
          ${staff.photos.length > 0 ? `<div style="margin:10px 0;"><strong>Photos:</strong></div>` : ""}
          <div style="display:flex; gap:5px; overflow-x:auto; padding:5px 0;">
            ${staff.photos.map(photo => `
              <div style="width:80px; height:80px; border-radius:8px; overflow:hidden; flex-shrink:0;">
                <img src="${photo}" style="width:100%; height:100%; object-fit:cover;">
              </div>
            `).join('')}
          </div>
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            üìÖ ${staff.date} | ‚è∞ ${staff.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    function renderLearning() {
      const list = document.getElementById("learningList");
      list.innerHTML = "";
      if (learningLogs.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No learning logs recorded today.</p>";
        return;
      }
      learningLogs.forEach(log => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #fdcb6e;";
        div.innerHTML = `
          <strong>${log.className}</strong>
          <div style="color:#636e72; margin:8px 0;"><strong>Topics:</strong> ${log.topics}</div>
          ${log.progress ? `<div style="color:#636e72; margin:8px 0;"><strong>Progress:</strong> ${log.progress}</div>` : ""}
          ${log.photos.length > 0 ? `<div style="margin:10px 0;"><strong>Class Photos:</strong></div>` : ""}
          <div style="display:flex; gap:5px; overflow-x:auto; padding:5px 0;">
            ${log.photos.map(photo => `
              <div style="width:80px; height:80px; border-radius:8px; overflow:hidden; flex-shrink:0;">
                <img src="${photo}" style="width:100%; height:100%; object-fit:cover;">
              </div>
            `).join('')}
          </div>
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            üìÖ ${log.date} | ‚è∞ ${log.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    function renderSales() {
      const list = document.getElementById("salesList");
      list.innerHTML = "";
      if (sales.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No sales recorded today.</p>";
        return;
      }
      let total = 0;
      sales.forEach(sale => {
        total += sale.amount;
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #fdcb6e;";
        div.innerHTML = `
          <strong>${sale.item}</strong>
          <div style="color:#636e72; margin:8px 0;">Amount: ‚Ç¶${sale.amount.toLocaleString()}</div>
          ${sale.notes ? `<div style="color:#636e72; margin:8px 0;">üìù ${sale.notes}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            üìÖ ${sale.date} | ‚è∞ ${sale.time}
          </div>
        `;
        list.appendChild(div);
      });
      document.getElementById("dailySalesTotal").textContent = `‚Ç¶${total.toLocaleString()}`;
    }

    function renderRegistrations() {
      const list = document.getElementById("registrationList");
      list.innerHTML = "";
      if (students.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No new students registered today.</p>";
        return;
      }
      students.forEach(student => {
        const div = document.createElement("div");
        div.style.cssText = "background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid #a55eea;";
        div.innerHTML = `
          <strong>${student.name}</strong>
          <div style="color:#636e72; margin:8px 0;">Age: ${student.age} | Class: ${student.className}</div>
          <div style="color:#636e72; margin:8px 0;">Parent: ${student.parent} | Phone: ${student.phone}</div>
          ${student.notes ? `<div style="color:#636e72; margin:8px 0;">üìù ${student.notes}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            üìÖ ${student.date} | ‚è∞ ${student.time}
          </div>
        `;
        list.appendChild(div);
      });
    }

    function renderFinance() {
      const list = document.getElementById("financeList");
      list.innerHTML = "";
      if (finances.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No financial transactions recorded today.</p>";
        return;
      }
      let income = 0;
      let expenses = 0;
      finances.forEach(trans => {
        if (trans.type === 'income') income += trans.amount;
        else if (trans.type === 'expense') expenses += trans.amount;
        const div = document.createElement("div");
        div.style.cssText = `background:white; padding:15px; border-radius:10px; margin:10px 0; border-left:4px solid ${trans.type === 'income' ? '#00b894' : '#e17055'};`;
        div.innerHTML = `
          <strong>${trans.type === 'income' ? 'üí∞' : 'üí∏'} ${trans.item}</strong>
          <div style="color:#636e72; margin:8px 0;">Amount: ‚Ç¶${trans.amount.toLocaleString()}</div>
          ${trans.notes ? `<div style="color:#636e72; margin:8px 0;">üìù ${trans.notes}</div>` : ""}
          <div style="color:#636e72; font-size:0.8rem; margin-top:8px;">
            üìÖ ${trans.date} | ‚è∞ ${trans.time}
          </div>
        `;
        list.appendChild(div);
      });
      const net = income - expenses;
      document.getElementById("totalIncome").textContent = `‚Ç¶${income.toLocaleString()}`;
      document.getElementById("totalExpenses").textContent = `‚Ç¶${expenses.toLocaleString()}`;
      document.getElementById("netBalance").textContent = `‚Ç¶${net.toLocaleString()}`;
    }

    function renderGallery() {
      const container = document.getElementById("galleryImages");
      container.innerHTML = "";
      if (galleryImages.length === 0) {
        container.innerHTML = "<p style='text-align:center; padding:20px;'>No images in gallery.</p>";
        return;
      }
      galleryImages.forEach(img => {
        const item = document.createElement("div");
        item.className = "gallery-item";
        item.innerHTML = `
          <img src="${img.src}" alt="Class photo">
          <button class="delete-img" onclick="deleteGalleryImage(${img.id})">√ó</button>
        `;
        container.appendChild(item);
      });
    }

    // ========================
    // 7. IMAGE HANDLING
    // ========================
    function previewImages(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      preview.innerHTML = '';
      if (input.files) {
        Array.from(input.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const item = document.createElement("div");
            item.className = "image-item";
            item.innerHTML = `
              <img src="${e.target.result}" alt="Preview">
              <button class="delete-img" onclick="this.parentElement.remove()">√ó</button>
            `;
            preview.appendChild(item);
          };
          reader.readAsDataURL(file);
        });
      }
    }

    document.getElementById("staffPhotos").addEventListener("change", () => previewImages("staffPhotos", "staffPhotoPreview"));
    document.getElementById("learningPhotos").addEventListener("change", () => previewImages("learningPhotos", "learningPhotoPreview"));

    // ========================
    // 8. DATA ENTRY FUNCTIONS
    // ========================
    function addClient() {
      const name = document.getElementById("clientName").value.trim();
      const phone = document.getElementById("clientPhone").value.trim();
      const email = document.getElementById("clientEmail").value.trim();
      const comment = document.getElementById("clientComment").value.trim();
      if (!name) {
        alert("Please enter client name");
        return;
      }
      const now = new Date();
      const client = {
        id: Date.now(),
        name,
        phone,
        email,
        comment,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };
      clients.push(client);
      saveData('clients', clients);
      renderClients();
      clearForm(['clientName', 'clientPhone', 'clientEmail', 'clientComment']);
      showToast("Client added!");
    }

    function addStaffActivity() {
      const name = document.getElementById("staffName").value.trim();
      const role = document.getElementById("staffRole").value;
      const activity = document.getElementById("staffActivity").value.trim();
      const photos = document.getElementById("staffPhotos").files;
      if (!name || !role || !activity) {
        alert("Please fill all fields");
        return;
      }
      const now = new Date();
      const staff = {
        id: Date.now(),
        name,
        role,
        activity,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString(),
        photos: []
      };
      if (photos.length > 0) {
        let loaded = 0;
        for (let i = 0; i < photos.length; i++) {
          const reader = new FileReader();
          reader.onload = function(e) {
            staff.photos.push(e.target.result);
            galleryImages.push({
              id: Date.now() + i,
              src: e.target.result,
              caption: `${name} - ${now.toLocaleDateString()}`,
              timestamp: now.toISOString()
            });
            loaded++;
            if (loaded === photos.length) {
              staffActivities.push(staff);
              saveData('staff', staffActivities);
              saveData('gallery', galleryImages);
              renderStaff();
              renderGallery();
              clearForm(['staffName', 'staffRole', 'staffActivity', 'staffPhotos']);
              showToast("Staff activity recorded!");
            }
          };
          reader.readAsDataURL(photos[i]);
        }
      } else {
        staffActivities.push(staff);
        saveData('staff', staffActivities);
        renderStaff();
        clearForm(['staffName', 'staffRole', 'staffActivity', 'staffPhotos']);
        showToast("Staff activity recorded!");
      }
    }

    function addLearningLog() {
      const className = document.getElementById("className").value.trim();
      const topics = document.getElementById("topicsCovered").value.trim();
      const progress = document.getElementById("studentProgress").value.trim();
      const photos = document.getElementById("learningPhotos").files;
      if (!className || !topics) {
        alert("Please fill required fields");
        return;
      }
      const now = new Date();
      const log = {
        id: Date.now(),
        className,
        topics,
        progress,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString(),
        photos: []
      };
      if (photos.length > 0) {
        let loaded = 0;
        for (let i = 0; i < photos.length; i++) {
          const reader = new FileReader();
          reader.onload = function(e) {
            log.photos.push(e.target.result);
            galleryImages.push({
              id: Date.now() + i,
              src: e.target.result,
              caption: `${className} - ${now.toLocaleDateString()}`,
              timestamp: now.toISOString()
            });
            loaded++;
            if (loaded === photos.length) {
              learningLogs.push(log);
              saveData('learning', learningLogs);
              saveData('gallery', galleryImages);
              renderLearning();
              renderGallery();
              clearForm(['className', 'topicsCovered', 'studentProgress', 'learningPhotos']);
              showToast("Learning log saved!");
            }
          };
          reader.readAsDataURL(photos[i]);
        }
      } else {
        learningLogs.push(log);
        saveData('learning', learningLogs);
        renderLearning();
        clearForm(['className', 'topicsCovered', 'studentProgress', 'learningPhotos']);
        showToast("Learning log saved!");
      }
    }

    function addSale() {
      const item = document.getElementById("saleItem").value.trim();
      const amount = parseFloat(document.getElementById("saleAmount").value);
      const notes = document.getElementById("saleNotes").value.trim();
      if (!item || isNaN(amount)) {
        alert("Please fill all fields correctly");
        return;
      }
      const now = new Date();
      const sale = {
        id: Date.now(),
        item,
        amount,
        notes,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };
      sales.push(sale);
      saveData('sales', sales);
      renderSales();
      clearForm(['saleItem', 'saleAmount', 'saleNotes']);
      showToast("Sale recorded!");
    }

    function registerStudent() {
      const name = document.getElementById("studentName").value.trim();
      const age = document.getElementById("studentAge").value.trim();
      const className = document.getElementById("studentClass").value.trim();
      const parent = document.getElementById("parentName").value.trim();
      const phone = document.getElementById("parentPhone").value.trim();
      const notes = document.getElementById("studentNotes").value.trim();
      if (!name || !age || !className || !parent || !phone) {
        alert("Please fill all required fields");
        return;
      }
      const now = new Date();
      const student = {
        id: Date.now(),
        name,
        age,
        className,
        parent,
        phone,
        notes,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };
      students.push(student);
      saveData('students', students);
      renderRegistrations();
      clearForm(['studentName', 'studentAge', 'studentClass', 'parentName', 'parentPhone', 'studentNotes']);
      showToast("Student registered!");
    }

    function addFinance() {
      const type = document.getElementById("financeType").value;
      const item = document.getElementById("financeItem").value.trim();
      const amount = parseFloat(document.getElementById("financeAmount").value);
      const notes = document.getElementById("financeNotes").value.trim();
      if (!type || !item || isNaN(amount)) {
        alert("Please fill all fields correctly");
        return;
      }
      const now = new Date();
      const transaction = {
        id: Date.now(),
        type,
        item,
        amount,
        notes,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString()
      };
      finances.push(transaction);
      saveData('finances', finances);
      renderFinance();
      clearForm(['financeType', 'financeItem', 'financeAmount', 'financeNotes']);
      showToast("Transaction recorded!");
    }

    // ========================
    // 9. CLEAR FUNCTIONS
    // ========================
    function clearClients() {
      if (confirm("Clear all client records?")) {
        clients = [];
        saveData('clients', clients);
        renderClients();
        showToast("Clients cleared!");
      }
    }
    function clearStaff() {
      if (confirm("Clear all staff records?")) {
        staffActivities = [];
        saveData('staff', staffActivities);
        renderStaff();
        showToast("Staff records cleared!");
      }
    }
    function clearLearning() {
      if (confirm("Clear all learning records?")) {
        learningLogs = [];
        saveData('learning', learningLogs);
        renderLearning();
        showToast("Learning logs cleared!");
      }
    }
    function clearSales() {
      if (confirm("Clear all sales records?")) {
        sales = [];
        saveData('sales', sales);
        renderSales();
        showToast("Sales cleared!");
      }
    }
    function clearRegistrations() {
      if (confirm("Clear all student registrations?")) {
        students = [];
        saveData('students', students);
        renderRegistrations();
        showToast("Student registrations cleared!");
      }
    }
    function clearFinance() {
      if (confirm("Clear all financial records?")) {
        finances = [];
        saveData('finances', finances);
        renderFinance();
        showToast("Finances cleared!");
      }
    }
    function clearGallery() {
      if (confirm("Clear all gallery images?")) {
        galleryImages = [];
        saveData('gallery', galleryImages);
        renderGallery();
        showToast("Gallery cleared!");
      }
    }

    function deleteGalleryImage(id) {
      if (confirm("Delete this image?")) {
        galleryImages = galleryImages.filter(img => img.id !== id);
        saveData('gallery', galleryImages);
        renderGallery();
        showToast("Image deleted!");
      }
    }

    // ========================
    // 10. REPORTS & EXPORT
    // ========================
    function updateReportStats() {
      document.getElementById("clientCount").textContent = clients.length;
      document.getElementById("staffCount").textContent = staffActivities.length;
      document.getElementById("learningCount").textContent = learningLogs.length;
      document.getElementById("salesCount").textContent = sales.length;
      document.getElementById("studentCount").textContent = students.length;
      document.getElementById("financeCount").textContent = finances.length;
    }

    function exportToCSV() {
      try {
        let csv = "Category,Details,Amount,Date,Time\n";
        clients.forEach(c => {
          csv += `Client,"${c.name}; ${c.phone || ''}; ${c.email || ''}",,"${c.date}","${c.time}"\n`;
        });
        staffActivities.forEach(s => {
          csv += `Staff,"${s.name} (${s.role}); ${s.activity}",,"${s.date}","${s.time}"\n`;
        });
        learningLogs.forEach(l => {
          csv += `Learning,"${l.className}; Topics: ${l.topics}; Progress: ${l.progress}",,"${l.date}","${l.time}"\n`;
        });
        sales.forEach(s => {
          csv += `Sale,"${s.item}; ${s.notes}",‚Ç¶${s.amount},"${s.date}","${s.time}"\n`;
        });
        students.forEach(st => {
          csv += `Student,"${st.name}; Age: ${st.age}; Class: ${st.className}; Parent: ${st.parent}; Phone: ${st.phone}; ${st.notes}",,"${st.date}","${st.time}"\n`;
        });
        finances.forEach(f => {
          csv += `${f.type.toUpperCase()},"${f.item}; ${f.notes}",‚Ç¶${f.amount},"${f.date}","${f.time}"\n`;
        });
        downloadFile(csv, `performance_report_${currentStaffId}_${new Date().toISOString().split("T")[0]}.csv`, "text/csv");
        showToast("CSV exported!");
      } catch (e) {
        console.error("CSV export error:", e);
        alert("Export failed.");
      }
    }

    function backupData() {
      const backup = {
        clients,
        staffActivities,
        learningLogs,
        sales,
        students,
        finances,
        galleryImages,
        signInData,
        timestamp: new Date().toISOString(),
        staffId: currentStaffId
      };
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tomstudio_backup_${currentStaffId}_${new Date().toISOString().split("T")[0]}.json`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 100);
      showToast("Backup created!");
    }

    // ========================
    // 11. PDF GENERATION (WITH IMAGES)
    // ========================
    function generatePDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const today = new Date().toLocaleDateString();
        const primaryColor = [108, 92, 231];
        const textColor = [66, 66, 66];
        const leftMargin = 20;
        let yPos = 50;

        // Header
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text("TOMSTUDIO DAILY PERFORMANCE TRACKER", 105, 20, null, null, "center");
        doc.setFontSize(14);
        doc.text("Daily Report with Images", 105, 30, null, null, "center");
        doc.setTextColor(...textColor);

        function addText(text, x, y, bold = false, size = 10) {
          doc.setFontSize(size);
          doc.setFont("helvetica", bold ? "bold" : "normal");
          doc.text(text, x, y);
          return y + 6;
        }

        function addWrapped(text, x, y, maxWidth, size = 10) {
          doc.setFontSize(size);
          const lines = doc.splitTextToSize(text, maxWidth);
          lines.forEach(line => {
            if (y > 280) {
              doc.addPage();
              y = 20;
            }
            doc.text(line, x, y);
            y += 5;
          });
          return y;
        }

        function addImage(imgData, caption = "") {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }
          const imgProps = doc.getImageProperties(imgData);
          const imgWidth = 50;
          const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

          doc.addImage(imgData, 'JPEG', leftMargin, yPos, imgWidth, imgHeight);
          yPos += imgHeight + 2;
          if (caption) yPos = addText(caption, leftMargin, yPos, false, 9);
          yPos += 4;
        }

        // Staff Info
        yPos = addText("STAFF INFORMATION", leftMargin, yPos, true, 12);
        yPos = addText(`Staff ID: ${currentStaffId}`, leftMargin, yPos);
        yPos = addText(`Date: ${today}`, leftMargin, yPos);
        if (signInData.location) {
          yPos = addText("GPS LOCATION", leftMargin, yPos, true, 12);
          yPos = addText(`Latitude: ${signInData.location.lat.toFixed(6)}`, leftMargin, yPos);
          yPos = addText(`Longitude: ${signInData.location.lng.toFixed(6)}`, leftMargin, yPos);
          yPos = addText(`Accuracy: ${signInData.location.accuracy}m`, leftMargin, yPos);
        }
        yPos += 6;

        // Clients
        if (clients.length > 0) {
          yPos = addText("CLIENTS/VISITORS", leftMargin, yPos, true, 12);
          clients.forEach(c => {
            if (yPos > 260) { doc.addPage(); yPos = 20; }
            yPos = addText(c.name, leftMargin, yPos, true);
            if (c.phone) yPos = addText(`üìû ${c.phone}`, leftMargin, yPos);
            if (c.email) yPos = addText(`‚úâÔ∏è ${c.email}`, leftMargin, yPos);
            if (c.comment) yPos = addWrapped(`üí¨ ${c.comment}`, leftMargin, yPos, 170);
            yPos = addText(`${c.date} ${c.time}`, leftMargin, yPos);
            yPos += 2;
          });
          yPos += 4;
        }

        // Learning with Images
        if (learningLogs.length > 0) {
          yPos = addText("STUDENT LEARNING LOGS", leftMargin, yPos, true, 12);
          learningLogs.forEach(log => {
            if (yPos > 260) { doc.addPage(); yPos = 20; }
            yPos = addText(log.className, leftMargin, yPos, true);
            yPos = addWrapped(`Topics: ${log.topics}`, leftMargin, yPos, 170);
            if (log.progress) yPos = addWrapped(`Progress: ${log.progress}`, leftMargin, yPos, 170);
            log.photos.forEach(photo => addImage(photo, `Class: ${log.className}`));
            yPos = addText(`${log.date} ${log.time}`, leftMargin, yPos);
            yPos += 2;
          });
          yPos += 4;
        }

        // Staff with Images
        if (staffActivities.length > 0) {
          yPos = addText("ONSITE STAFF ACTIVITIES", leftMargin, yPos, true, 12);
          staffActivities.forEach(staff => {
            if (yPos > 260) { doc.addPage(); yPos = 20; }
            yPos = addText(`${staff.name} (${staff.role})`, leftMargin, yPos, true);
            yPos = addWrapped(staff.activity, leftMargin, yPos, 170);
            staff.photos.forEach(photo => addImage(photo, `Staff: ${staff.name}`));
            yPos = addText(`${staff.date} ${staff.time}`, leftMargin, yPos);
            yPos += 2;
          });
          yPos += 4;
        }

        // Gallery Images
        if (galleryImages.length > 0) {
          yPos = addText("CLASS GALLERY", leftMargin, yPos, true, 12);
          galleryImages.forEach(img => addImage(img.src, img.caption || "Class Photo"));
        }

        // Footer
        doc.setDrawColor(...primaryColor);
        doc.line(20, 285, 190, 285);
        doc.setFontSize(9);
        doc.setTextColor(255, 255, 255);
        doc.text("App Design and Developed by Tomstudio Tech Academy", 105, 290, null, null, "center");
        doc.text("+2348030827417", 105, 295, null, null, "center");

        doc.save(`Report_${currentStaffId}_${today.replace(/\//g, '-')}.pdf`);
        showToast("PDF generated!");
      } catch (e) {
        alert("PDF generation failed. Some images may be too large.");
        console.error(e);
      }
    }

    // ========================
    // 12. UTILITIES
    // ========================
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    function loadAllData() {
      clients = loadData('clients');
      staffActivities = loadData('staff');
      learningLogs = loadData('learning');
      sales = loadData('sales');
      students = loadData('students');
      finances = loadData('finances');
      galleryImages = loadData('gallery') || [];
      renderClients(); renderStaff(); renderLearning(); renderSales();
      renderRegistrations(); renderFinance(); renderGallery(); updateReportStats();
      displaySignInData();
    }

    // ========================
    // 13. INIT & SERVICE WORKER
    // ========================
    window.onload = function() {
      loadAllData();
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(e => console.log('SW failed:', e));
      }
      window.addEventListener('online', () => { isOnline = true; showToast("Back online!"); });
      window.addEventListener('offline', () => { isOnline = false; showToast("You are offline."); });
    };
  </script>
</body>
</html>